!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@aspnet/signalr"),require("jquery"),require("jquery-ui/ui/widgets/draggable"),require("jquery-ui/ui/widgets/droppable"),require("jquery-mousewheel")):"function"==typeof define&&define.amd?define("ngx-modelstage",["exports","@aspnet/signalr","jquery","jquery-ui/ui/widgets/draggable","jquery-ui/ui/widgets/droppable","jquery-mousewheel"],t):t(e["ngx-modelstage"]={},e.signalr,e.JQuery)}(this,function(te,re,r){"use strict";var ne="default"in r?r["default"]:r;!function(e){var a=function(){function a(e){this.elements=e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}return a.FromTranslation=function(e,t,r){var n=new a;return n.elements[3]=e,n.elements[7]=t,n.elements[11]=r,n},a.FromScaling=function(e,t,r){var n=new a;return n.elements[0]=e,n.elements[5]=t,n.elements[10]=r,n},a.FromRotationX=function(e){var t=Math.cos(e),r=Math.sin(e),n=new a;return n.elements[5]=t,n.elements[6]=-r,n.elements[9]=r,n.elements[10]=t,n},a.FromRotationY=function(e){var t=Math.cos(e),r=Math.sin(e),n=new a;return n.elements[0]=t,n.elements[2]=r,n.elements[8]=-r,n.elements[10]=t,n},a.FromRotationZ=function(e){var t=Math.cos(e),r=Math.sin(e),n=new a;return n.elements[0]=t,n.elements[1]=-r,n.elements[4]=r,n.elements[5]=t,n},a.FromRotation=function(e,t,r){return new a([Math.cos(t)*Math.cos(e),Math.sin(t)*Math.cos(e),-Math.sin(e),0,Math.cos(t)*Math.sin(e)*Math.sin(r)-Math.sin(t)*Math.cos(r),Math.sin(t)*Math.sin(e)*Math.sin(r)+Math.cos(t)*Math.cos(r),Math.cos(e)*Math.sin(r),0,Math.cos(t)*Math.sin(e)*Math.cos(r)+Math.sin(t)*Math.sin(r),Math.sin(t)*Math.sin(e)*Math.cos(r)-Math.cos(t)*Math.sin(r),Math.cos(e)*Math.cos(r),0,0,0,0,1]).transpose()},a.prototype.e=function(e,t){var r=e+4*(t||0);return 0<=r&&r<16?this.elements[r]:null},a.prototype.row=function(e){return 0<=e&&e<4?new s(this.elements[4*e],this.elements[4*e+1],this.elements[4*e+2],this.elements[4*e+3]):null},a.prototype.col=function(e){return e<=0&&e<4?new s(this.elements[e],this.elements[e+4],this.elements[e+8],this.elements[e+12]):null},a.prototype.equals=function(e){if(e){var t=this.elements,r=e.elements;return t[0]==r[0]&&t[1]==r[1]&&t[2]==r[2]&&t[3]==r[3]&&t[4]==r[4]&&t[5]==r[5]&&t[6]==r[6]&&t[7]==r[7]&&t[8]==r[8]&&t[9]==r[9]&&t[10]==r[10]&&t[11]==r[11]&&t[12]==r[12]&&t[13]==r[13]&&t[14]==r[14]&&t[15]==r[15]}return!1},a.prototype.multiply=function(t){if(t instanceof a){var e=this.elements,r=t.elements;return new a([e[0]*r[0]+e[4]*r[1]+e[8]*r[2]+e[12]*r[3],e[1]*r[0]+e[5]*r[1]+e[9]*r[2]+e[13]*r[3],e[2]*r[0]+e[6]*r[1]+e[10]*r[2]+e[14]*r[3],e[3]*r[0]+e[7]*r[1]+e[11]*r[2]+e[15]*r[3],e[0]*r[4]+e[4]*r[5]+e[8]*r[6]+e[12]*r[7],e[1]*r[4]+e[5]*r[5]+e[9]*r[6]+e[13]*r[7],e[2]*r[4]+e[6]*r[5]+e[10]*r[6]+e[14]*r[7],e[3]*r[4]+e[7]*r[5]+e[11]*r[6]+e[15]*r[7],e[0]*r[8]+e[4]*r[9]+e[8]*r[10]+e[12]*r[11],e[1]*r[8]+e[5]*r[9]+e[9]*r[10]+e[13]*r[11],e[2]*r[8]+e[6]*r[9]+e[10]*r[10]+e[14]*r[11],e[3]*r[8]+e[7]*r[9]+e[11]*r[10]+e[15]*r[11],e[0]*r[12]+e[4]*r[13]+e[8]*r[14]+e[12]*r[15],e[1]*r[12]+e[5]*r[13]+e[9]*r[14]+e[13]*r[15],e[2]*r[12]+e[6]*r[13]+e[10]*r[14]+e[14]*r[15],e[3]*r[12]+e[7]*r[13]+e[11]*r[14]+e[15]*r[15]])}return t instanceof s?new s(t.x*this.elements[0]+t.y*this.elements[1]+t.z*this.elements[2]+t.w*this.elements[3],t.x*this.elements[4]+t.y*this.elements[5]+t.z*this.elements[6]+t.w*this.elements[7],t.x*this.elements[8]+t.y*this.elements[9]+t.z*this.elements[10]+t.w*this.elements[11],t.x*this.elements[12]+t.y*this.elements[13]+t.z*this.elements[14]+t.w*this.elements[15]):new a(this.elements.map(function(e){return e*t}))},a.prototype.toRightTriangular=function(){return new a(c.toRightTriangular(this.elements,4,4))},a.prototype.determinant=function(){var e=this.toRightTriangular();return e.elements[0]*e.elements[5]*e.elements[10]*e.elements[15]},a.prototype.isSingular=function(){return 0===this.determinant()},a.prototype.transpose=function(){var e=this.elements;return new a([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])},a.prototype.inverse=function(){if(this.isSingular())return null;for(var e=[this.elements[0],this.elements[1],this.elements[2],this.elements[3],1,0,0,0,this.elements[4],this.elements[5],this.elements[6],this.elements[7],0,1,0,0,this.elements[8],this.elements[9],this.elements[10],this.elements[11],0,0,1,0,this.elements[12],this.elements[13],this.elements[14],this.elements[15],0,0,0,1],t=c.toRightTriangular(e,4,8),r=3;0<=r;r--){for(var n=t[9*r],i=0;i<8;i++)t[8*r+i]=t[8*r+i]/n;for(var o=r-1;0<=o;o--){var s=t[8*o+r];for(i=0;i<8;i++)t[8*o+i]=t[8*o+i]-t[8*r+i]*s}}return new a([t[4],t[5],t[6],t[7],t[12],t[13],t[14],t[15],t[20],t[21],t[22],t[23],t[28],t[29],t[30],t[31]])},a.Identity=new a,a}();e.Matrix4=a;var o=function(){function a(e){this.elements=e||[1,0,0,0,1,0,0,0,1]}return a.prototype.e=function(e,t){var r=e+3*(t||0);return 0<=r&&r<9?this.elements[r]:null},a.prototype.row=function(e){return 0<=e&&e<3?new h(this.elements[3*e],this.elements[3*e+1],this.elements[3*e+2]):null},a.prototype.col=function(e){return e<=0&&e<3?new h(this.elements[e],this.elements[e+3],this.elements[e+6]):null},a.prototype.multiply=function(t){if(t instanceof a){var e=this.elements,r=t.elements;return new a([e[0]*r[0]+e[3]*r[1]+e[6]*r[2],e[1]*r[0]+e[4]*r[1]+e[7]*r[2],e[2]*r[0]+e[5]*r[1]+e[8]*r[2],e[0]*r[3]+e[3]*r[4]+e[6]*r[5],e[1]*r[3]+e[4]*r[4]+e[7]*r[5],e[2]*r[3]+e[5]*r[4]+e[8]*r[5],e[0]*r[6]+e[3]*r[7]+e[6]*r[8],e[1]*r[6]+e[4]*r[7]+e[7]*r[8],e[2]*r[6]+e[5]*r[7]+e[8]*r[8]])}return t instanceof h?new h(t.x*this.elements[0]+t.y*this.elements[1]+t.z*this.elements[2],t.x*this.elements[3]+t.y*this.elements[4]+t.z*this.elements[5],t.x*this.elements[6]+t.y*this.elements[7]+t.z*this.elements[8]):new a(this.elements.map(function(e){return e*t}))},a.prototype.toRightTriangular=function(){return new a(c.toRightTriangular(this.elements,3,3))},a.prototype.determinant=function(){var e=this.toRightTriangular();return e.elements[0]*e.elements[4]*e.elements[8]},a.prototype.isSingular=function(){return 0===this.determinant()},a.prototype.transpose=function(){var e=this.elements;return new a([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])},a.prototype.inverse=function(){if(this.isSingular())return null;for(var e=[this.elements[0],this.elements[1],this.elements[2],1,0,0,this.elements[3],this.elements[4],this.elements[5],0,1,0,this.elements[6],this.elements[7],this.elements[8],0,0,1],t=c.toRightTriangular(e,3,6),r=2;0<=r;r--){for(var n=t[7*r],i=0;i<6;i++)t[7*r+i]=t[7*r+i]/n;for(var o=r-1;0<=o;o--){var s=t[6*o+r];for(i=0;i<6;i++)t[6*o+i]=t[6*o+i]-t[6*r+i]*s}}return new a([t[3],t[4],t[5],t[9],t[10],t[11],t[15],t[16],t[17]])},a.Identity=new a,a}();e.Matrix3=o;var c=function(){function e(){}return e.toRightTriangular=function(e,t,r){for(var n=e.slice(0),i=0;i<t;i++){if(0==n[i*(r+1)])for(var o=i+1;o<t;o++)if(0!=n[o*r+i]){for(var s=0;s<r;s++)n[i*r+s]+=n[o*r+s];break}if(0!=n[i*(r+1)])for(o=i+1;o<t;o++){var a=n[o*r+i]/n[i*(r+1)];for(s=0;s<r;s++)n[o*r+s]=s<i?0:n[o*r+s]-n[i*r+s]*a}}return n},e}();e.Matrix=c;var h=function(){function t(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}return t.prototype.asVec3=function(){return this},t.prototype.asVec4=function(e){return new s(this.x,this.y,this.z,e||1)},t.prototype.equals=function(e){return this.x==e.x&&this.y==e.y&&this.z==e.z},t.prototype.assignPoint=function(e,t,r){this.x=e,this.y=t,this.z=r},t.prototype.assignVec=function(e){this.x=e.x,this.y=e.y,this.z=e.z},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.sub=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.multiply=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.applyQuaternion=function(e){var t=this.x,r=this.y,n=this.z,i=e.x,o=e.y,s=e.z,a=e.w,c=a*t+o*n-s*r,u=a*r+s*t-i*n,h=a*n+i*r-o*t,l=-i*t-o*r-s*n;return this.x=c*a-l*i-u*s+h*o,this.y=u*a-l*o-h*i+c*s,this.z=h*a-l*s-c*o+u*i,this},t.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.normalize=function(){return this.multiply(1/this.norm())},t.prototype.elements=function(){return[this.x,this.y,this.z]},t.prototype.squaredDist=function(e){return(this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y)+(this.z-e.z)*(this.z-e.z)},t}();e.Vec3=h;var s=function(){function t(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=n||0}return t.prototype.equals=function(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.w==e.w},t.prototype.asVec3=function(){return new h(this.x,this.y,this.z)},t.prototype.asVec4=function(){return this},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.sub=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},t.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x,1)},t.prototype.multiply=function(e){return new t(this.x*e,this.y*e,this.z*e,this.w*e)},t.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){return this.multiply(1/this.norm())},t.prototype.elements=function(){return[this.x,this.y,this.z,this.w]},t.prototype.squaredDist=function(e){return(this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y)+(this.z-e.z)*(this.z-e.z)+(this.w-e.w)*(this.w-e.w)},t.Zero=new t(0,0,0,0),t.One=new t(1,1,1,1),t}();e.Vec4=s;var t=function(){function e(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0===n?1:n}return e.prototype.setFromAxisAngle=function(e,t){var r=t/2,n=Math.sin(r);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(r),this},e.prototype.multiply=function(e){var t=this.x,r=this.y,n=this.z,i=this.w,o=e.x,s=e.y,a=e.z,c=e.w;this.x=t*c+i*o+r*a-n*s,this.y=r*c+i*s+n*o-t*a,this.z=n*c+i*a+t*s-r*o,this.w=i*c-t*o-r*s-n*a},e}();e.Quaternion=t;var r=function(){function i(){this.minX=+Infinity,this.maxX=-Infinity,this.minY=+Infinity,this.maxY=-Infinity,this.minZ=+Infinity,this.maxZ=-Infinity}return i.prototype.addPoint=function(e,t,r){this.minX=Math.min(this.minX,e),this.maxX=Math.max(this.maxX,e),this.minY=Math.min(this.minY,t),this.maxY=Math.max(this.maxY,t),this.minZ=Math.min(this.minZ,r),this.maxZ=Math.max(this.maxZ,r)},i.prototype.addVector=function(e){this.addPoint(e.x,e.y,e.z)},i.prototype.addAABB=function(e){this.addPoint(e.minX,e.minY,e.minZ),this.addPoint(e.maxX,e.maxY,e.maxZ)},i.prototype.clear=function(){this.minX=+Infinity,this.maxX=-Infinity,this.minY=+Infinity,this.maxY=-Infinity,this.minZ=+Infinity,this.maxZ=-Infinity},i.prototype.center=function(){return new h(.5*(this.minX+this.maxX),.5*(this.minY+this.maxY),.5*(this.minZ+this.maxZ))},i.prototype.extents=function(){return new h(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},i.prototype.min=function(){return new h(this.minX,this.minY,this.minZ)},i.prototype.max=function(){return new h(this.maxX,this.maxY,this.maxZ)},i.prototype.contains=function(e){return e.x>=this.minX&&e.x<=this.maxX&&e.y>=this.minY&&e.y<=this.maxY&&e.z>=this.minZ&&e.z<=this.maxZ},i.prototype.transform=function(e){var t=new i,r=e.multiply(new s(this.minX,this.minY,this.minZ,1)),n=e.multiply(new s(this.maxX,this.maxY,this.maxZ,1));return t.minX=r.x,t.minY=r.y,t.minZ=r.z,t.maxX=n.x,t.maxY=n.y,t.maxZ=n.z,t},i.prototype.intersectsRay=function(e){var t=null,r=e.p0.asVec3(),n=(e.p1.asVec3().sub(e.p0.asVec3()),e.intersectRayWithPlane(new h(this.minX,0,0),new h(-1,0,0))),i=e.intersectRayWithPlane(new h(this.maxX,0,0),new h(1,0,0)),o=e.intersectRayWithPlane(new h(0,this.minY,0),new h(0,-1,0)),s=e.intersectRayWithPlane(new h(0,this.maxY,0),new h(0,1,0)),a=e.intersectRayWithPlane(new h(0,0,this.minZ),new h(0,0,-1)),c=e.intersectRayWithPlane(new h(0,0,this.maxZ),new h(0,0,1)),u=Infinity;return n&&this.contains(n)&&(u=r.squaredDist(n),t=n),i&&this.contains(i)&&r.squaredDist(i)<u&&(u=r.squaredDist(i),t=i),o&&this.contains(o)&&r.squaredDist(o)<u&&(u=r.squaredDist(o),t=o),s&&this.contains(s)&&r.squaredDist(s)<u&&(u=r.squaredDist(s),t=s),a&&this.contains(a)&&r.squaredDist(a)<u&&(u=r.squaredDist(a),t=a),c&&this.contains(c)&&r.squaredDist(c)<u&&(u=r.squaredDist(c),t=c),t},i}();e.AABB3D=r;var i=function(){function e(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}return e.prototype.asVec3=function(){return new h(this.x,this.y,this.z)},e.prototype.asVec4=function(e){return new s(this.x,this.y,this.z,e||1)},e}();e.Point3D=i;var n=function(){function n(e,t){this.p0=e||new i,this.p1=t||new i}return n.prototype.intersectRayWithPlane=function(e,t){var r=null,n=this.p1.asVec3().sub(this.p0.asVec3()),i=t.dot(n);if(0!=i){var o=this.p0.asVec3().sub(e),s=-t.dot(o)/i;0<=s&&(r=this.p0.asVec3().add(n.multiply(s)))}return r},n.prototype.intersectTriangle=function(e,t,r){var n=new o([this.p0.x-this.p1.x,t.x-e.x,r.x-e.x,this.p0.y-this.p1.y,t.y-e.y,r.y-e.y,this.p0.z-this.p1.z,t.z-e.z,r.z-e.z]).inverse();if(n){var i=n.multiply(this.p0.asVec3().sub(e.asVec3()));return i&&0<=i.y&&i.y<=1&&0<=i.z&&i.z<=1&&i.y+i.z<=1?e.asVec3().add(t.asVec3().sub(e.asVec3()).multiply(i.y)).add(r.asVec3().sub(e.asVec3()).multiply(i.z)):null}return null},n.prototype.transform=function(e){var t=e.multiply(this.p0.asVec4()),r=e.multiply(this.p1.asVec4());return new n(new i(t.x,t.y,t.z),new i(r.x,r.y,r.z))},n}();e.Line3D=n;var u=function(){function e(e,t,r){this._position=e||new h(0,0,20),this._direction=t||new h(0,0,-1),this._up=r||new h(0,1,0)}return e.prototype.changed=function(){this.currentViewMatrix=null},e.prototype.setPosition=function(e,t,r){this._position.x=e||0,this._position.y=t||0,this._position.z=r||0,this.changed()},e.prototype.setDirection=function(e,t,r){this._direction.x=e,this._direction.y=t,this._direction.z=r,this.changed()},e.prototype.setCenter=function(e,t,r){this._direction.x=e-this._position.x,this._direction.y=t-this._position.y,this._direction.z=r-this._position.z,this.changed()},e.prototype.getPosition=function(){return this._position},e.prototype.asVec3=function(){return this._position},e.prototype.asVec4=function(){return this._position.asVec4()},e.prototype.getProjectionMatrix=function(e,t){return this.makePerspective(45,e/t,.1,1e4)},e.prototype.getViewMatrix=function(){return this.makeLookAt()},e.prototype.makePerspective=function(e,t,r,n){var i=r*Math.tan(e*Math.PI/360),o=-i,s=o*t,a=i*t;return this.makeFrustum(s,a,o,i,r,n)},e.prototype.makeFrustum=function(e,t,r,n,i,o){return new a([2*i/(t-e),0,(t+e)/(t-e),0,0,2*i/(n-r),(n+r)/(n-r),0,0,0,-(o+i)/(o-i),-2*o*i/(o-i),0,0,-1,0])},e.prototype.makeOrtho=function(e,t,r,n,i,o){return new a([2/(t-e),0,0,-(t+e)/(t-e),0,2/(n-r),0,-(n+r)/(n-r),0,0,-2/(o-i),-(o+i)/(o-i),0,0,0,1])},e.prototype.makeLookAt=function(){var e=this._position,t=this._position.add(this._direction),r=this._up,n=e.sub(t).normalize(),i=r.cross(n).normalize(),o=n.cross(i).normalize(),s=new a([i.x,i.y,i.z,0,o.x,o.y,o.z,0,n.x,n.y,n.z,0,0,0,0,1]);return new a([1,0,0,-e.x,0,1,0,-e.y,0,0,1,-e.z,0,0,0,1]).multiply(s)},e}();e.Camera=u;var l=function(){function i(e,t){this.x=e||0,this.y=t||0}return i.prototype.sub=function(e){return new i(this.x-e.x,this.y-e.y)},i.insideTri=function(e,t,r,n){return 0<=i.cross(r.sub(t),n.sub(t))&&0<=i.cross(e.sub(r),n.sub(r))&&0<=i.cross(t.sub(e),n.sub(e))},i.cross=function(e,t){return e.x*t.y-e.y*t.x},i}();e.Vec2=l;var p=function(){function d(){this.vertices=[]}return Object.defineProperty(d.prototype,"Vertices",{get:function(){return this.vertices},enumerable:!0,configurable:!0}),d.prototype.addVertex=function(e,t){this.vertices.push(new l(e,t))},d.prototype.addVector=function(e){this.vertices.push(e)},d.prototype.addToAABB=function(t){this.vertices.forEach(function(e){t.addVector(e)})},d.prototype.clear=function(){this.vertices.length=0},d.prototype.getArea=function(){for(var e=0,t=this.vertices.length,r=t-1,n=0;n<t;r=n++)e+=this.vertices[r].x*this.vertices[n].y-this.vertices[n].x*this.vertices[r].y;return.5*e},d.prototype.snip=function(e,t,r,n,i){var o,s,a=this.vertices[i[e]],c=this.vertices[i[t]],u=this.vertices[i[r]];o=(c.x-a.x)*(u.y-a.y)-(c.y-a.y)*(u.x-a.x)>d.Epsilon;for(var h=0;h<n&&o;++h)h!=e&&h!=t&&h!=r&&(s=this.vertices[i[h]],o=!l.insideTri(a,c,u,s));return o},d.prototype.triangulate=function(){var e=new d,t=this.vertices.length;if(2<t){var r=[];if(0<this.getArea())for(var n=0;n<t;++n)r[n]=n;else for(n=0;n<t;++n)r[n]=t-1-n;for(var i=t,o=2*i,s=i-1;2<i;){if(o--<=0)return new d;var a=s;i<=a&&(a=0),i<=(s=a+1)&&(s=0);var c=s+1;if(i<=c&&(c=0),this.snip(a,s,c,i,r)){var u,h,l,p=void 0,f=void 0;for(u=r[a],h=r[s],l=r[c],e.addVector(this.vertices[l]),e.addVector(this.vertices[h]),e.addVector(this.vertices[u]),f=(p=s)+1;f<i;p++,f++)r[p]=r[f];o=2*--i}}}return e},d.Epsilon=1e-10,d}();e.Polygon2D=p;var f=function(){function e(){this.minX=+Infinity,this.maxX=-Infinity,this.minY=+Infinity,this.maxY=-Infinity}return e.prototype.addPoint=function(e,t){this.minX=Math.min(this.minX,e),this.maxX=Math.max(this.maxX,e),this.minY=Math.min(this.minY,t),this.maxY=Math.max(this.maxY,t)},e.prototype.addVector=function(e){this.addPoint(e.x,e.y)},e.prototype.addAABB=function(e){this.addPoint(e.minX,e.minY),this.addPoint(e.maxX,e.maxY)},e.prototype.clear=function(){this.minX=+Infinity,this.maxX=-Infinity,this.minY=+Infinity,this.maxY=-Infinity},e.prototype.center=function(){return new l(.5*(this.minX+this.maxX),.5*(this.minY+this.maxY))},e.prototype.extents=function(){return new l(this.maxX-this.minX,this.maxY-this.minY)},e.prototype.min=function(){return new l(this.minX,this.minY)},e.prototype.max=function(){return new l(this.maxX,this.maxY)},e.prototype.contains=function(e){return e.x>=this.minX&&e.x<=this.maxX&&e.y>=this.minY&&e.y<=this.maxY},e}();e.AABB2D=f;var d=function(){function i(e,t,r){this.r=0,this.azimuth=0,this.polar=0,this.r=e,this.azimuth=t,this.polar=r}return i.FromCartesian=function(e,t,r){var n=Math.sqrt(e*e+t*t+r*r);return new i(n,Math.asin(t/n),Math.atan2(-e,r))},i.FromCartesianVector=function(e){return i.FromCartesian(e.x,e.y,e.z)},i.ToCartesian=function(e,t,r){return new s(e*Math.cos(t)*Math.sin(r),-e*Math.sin(t),-e*Math.cos(t)*Math.cos(r))},i.prototype.toCartesian=function(){return new s(this.r*Math.cos(this.polar)*Math.sin(this.azimuth),-this.r*Math.sin(this.polar),-this.r*Math.cos(this.polar)*Math.cos(this.azimuth))},i}();e.Spherical=d}(te.psgeometry||(te.psgeometry={}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function ie(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var x=function(){return(x=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function S(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)s.push(n.value)}catch(a){i={error:a}}finally{try{n&&!n.done&&(r=o["return"])&&r.call(o)}finally{if(i)throw i.error}}return s}!function(i){i.uuidv4=function J(){var t=window.crypto||window.msCrypto;return(""+1e7+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^t.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})};var n=function(){function e(e){this.stage=e}return e.prototype.createShader=function(e,t){var r=this.stage.gl.createShader(e);return this.stage.gl.shaderSource(r,t),this.stage.gl.compileShader(r),console.log(this.stage.gl.getShaderInfoLog(r)),r},e}();i.ToolsWebGL=n;var r,e,o=function(){function e(){}return Object.defineProperty(e.prototype,"BlockType",{get:function(){return this.blockType},set:function(e){this.blockType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MajorVersion",{get:function(){return this.majorVersion},set:function(e){this.majorVersion=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MinorVersion",{get:function(){return this.minorVersion},set:function(e){this.minorVersion=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Flags",{get:function(){return this.flags},set:function(e){this.flags=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"PayloadBytes",{get:function(){return this.payloadBytes},set:function(e){this.payloadBytes=e},enumerable:!0,configurable:!0}),e}();i.BlockStreamBlockDescriptor=o,(e=r=i.BlockStreamReaderStates||(i.BlockStreamReaderStates={}))[e.FILE_HEADER_EXPECTED=0]="FILE_HEADER_EXPECTED",e[e.BLOCK_DESCRIPTOR_EXPECTED=1]="BLOCK_DESCRIPTOR_EXPECTED",e[e.PAYLOAD_EXPECTED=2]="PAYLOAD_EXPECTED";var s=function(){function e(e){this.arrayBuffer=null,this.byteArray=null,this.currentPos=0,this.blockEnd=0,this.isComplete=!1,this.fatalError=!1,this.state=r.FILE_HEADER_EXPECTED,this.arrayBuffer=e,this.byteArray=new Uint8Array(e),this.assureFileHeader()}return Object.defineProperty(e.prototype,"CurrentBlockDescriptor",{get:function(){return this.currentBlockDescriptor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"FatalError",{get:function(){return this.fatalError},enumerable:!0,configurable:!0}),e.prototype.remainingBytesInBlock=function(){return this.blockEnd-this.currentPos},e.prototype.assureRemainingBytesInBlock=function(e){return this.currentPos+e<=this.blockEnd},e.prototype.readBytes=function(e){return this.arrayBuffer.slice(this.currentPos,this.currentPos+e)},e.prototype.tryReadInt16=function(e){var t=this.assureRemainingBytesInBlock(2);return t&&e(this.byteArray[this.currentPos++]+256*this.byteArray[this.currentPos++]),t},e.prototype.tryReadFloat=function(e){var t=this.assureRemainingBytesInBlock(4);if(t){var r=new ArrayBuffer(4),n=new DataView(r);n.setUint8(0,this.byteArray[this.currentPos++]),n.setUint8(1,this.byteArray[this.currentPos++]),n.setUint8(2,this.byteArray[this.currentPos++]),n.setUint8(3,this.byteArray[this.currentPos++]),e(n.getFloat32(0,!0))}return t},e.prototype.tryReadInt=function(e){var t=this.assureRemainingBytesInBlock(4);return t&&e(this.byteArray[this.currentPos++]+256*this.byteArray[this.currentPos++]+65536*this.byteArray[this.currentPos++]+16777216*this.byteArray[this.currentPos++]),t},e.prototype.tryReadInt64=function(e){var t=this.assureRemainingBytesInBlock(8);return t&&e(this.byteArray[this.currentPos++]+256*this.byteArray[this.currentPos++]+65536*this.byteArray[this.currentPos++]+16777216*this.byteArray[this.currentPos++]+4294967296*this.byteArray[this.currentPos++]+1099511627776*this.byteArray[this.currentPos++]+281474976710656*this.byteArray[this.currentPos++]+72057594037927940*this.byteArray[this.currentPos++]),t},e.prototype.tryReadString=function(n){var i=this,o=!1;return this.tryReadInt(function(e){var t="";if(i.assureRemainingBytesInBlock(e))for(var r=0;r<e;++r)t+=String.fromCharCode(i.byteArray[i.currentPos++]);n(t),o=!0}),o},e.prototype.readString=function(){var t="";return this.tryReadString(function(e){t=e}),t},e.prototype.readMatrix4=function(){for(var r=new te.psgeometry.Matrix4,e=function(t){n.tryReadFloat(function(e){r.elements[t]=e})},n=this,t=0;t<16;++t)e(t);return r.transpose()},e.prototype.internalReadString=function(e,t){for(var r="",n=0;n<t;++n)r+=String.fromCharCode(this.byteArray[e+n]);return r},e.prototype.internalReadInt=function(e){return this.byteArray[e]+256*this.byteArray[e+1]+65536*this.byteArray[e+2]+16777216*this.byteArray[e+3]},e.prototype.assureFileHeader=function(){8<=this.byteArray.byteLength?112==this.byteArray[0]&&115==this.byteArray[1]&&98==this.byteArray[2]&&108==this.byteArray[3]&&115==this.byteArray[4]&&116==this.byteArray[5]&&114==this.byteArray[6]&&49==this.byteArray[7]?(this.currentPos+=8,this.state=r.BLOCK_DESCRIPTOR_EXPECTED):this.fatalError=!0:this.fatalError=this.isComplete},e.prototype.enterBlock=function(){var e={success:!1,descriptor:null};if(this.byteArray.byteLength>=this.currentPos+5)if(112==this.byteArray[this.currentPos]&&115==this.byteArray[this.currentPos+1]&&98==this.byteArray[this.currentPos+2]&&108==this.byteArray[this.currentPos+3]){var t=this.byteArray[this.currentPos+4];this.byteArray.byteLength>=this.currentPos+5+t+8?(e.descriptor=new o,e.descriptor.BlockType=this.internalReadString(this.currentPos+5,t),e.descriptor.MajorVersion=this.byteArray[this.currentPos+5+t],e.descriptor.MinorVersion=this.byteArray[this.currentPos+5+t+1],e.descriptor.Flags=256*this.byteArray[this.currentPos+5+t+2]+this.byteArray[this.currentPos+5+t+3],e.descriptor.PayloadBytes=this.internalReadInt(this.currentPos+5+t+4),this.state=r.PAYLOAD_EXPECTED,this.currentPos+=5+t+8,this.blockEnd=this.currentPos+e.descriptor.PayloadBytes,this.currentBlockDescriptor=e.descriptor,e.success=!0):this.fatalError=this.isComplete}else this.fatalError=!0;else this.fatalError=this.isComplete&&this.byteArray.byteLength>this.currentPos;return e},e.prototype.leaveBlock=function(){this.currentPos=this.blockEnd,this.state=r.BLOCK_DESCRIPTOR_EXPECTED},e}();i.BlockStreamReader=s;var t=function(){function e(e){this.references={},this.shaderKey=e}return Object.defineProperty(e.prototype,"FigureID",{get:function(){return this.figureID},set:function(e){this.figureID=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShaderKey",{get:function(){return this.shaderKey},set:function(e){this.shaderKey=e},enumerable:!0,configurable:!0}),e.prototype.getReference=function(e){return this.references[e]},e.prototype.construct=function(e){},e.prototype.addReference=function(e,t){this.references[e]=t},e}(),a=function(r){function e(e){var t=r.call(this,e)||this;return t.SIZE_OF_FLOAT=4,t}return ie(e,r),e.prototype.construct=function(e){var t=this;e.tryReadString(function(e){t.bufferID=e})||(this.bufferID="_default"),e.tryReadInt16(function(e){t.priority=e})||(this.priority=0)},e.prototype.getStride=function(){return"TransparentMeshShader"==this.ShaderKey?10*this.SIZE_OF_FLOAT:9*this.SIZE_OF_FLOAT},e}(i.ShaderInstance=t),c=function(r){function e(e){return r.call(this,e)||this}return ie(e,r),Object.defineProperty(e.prototype,"TextureID",{get:function(){return this.textureID},enumerable:!0,configurable:!0}),e.prototype.construct=function(e){var t=this;e.tryReadString(function(e){t.textureID=e})&&(this.addReference("TextureBuffer",this.textureID),r.prototype.construct.call(this,e))},e.prototype.getStride=function(){return 11*this.SIZE_OF_FLOAT},e}(i.MeshShaderInstance=a);i.TexturedMeshShaderInstance=c;var u=function(){function e(e){this.objectNamePrefix=e}return e.prototype.setRootNode=function(e){this.rootNode=e},e.prototype.getNodeFromPath=function(e){return 0!=e.length&&this.rootNode&&this.rootNode.Name!=e?this.rootNode.getChildNodeFromPath(e.substr(this.rootNode.Name.length)):this.rootNode},e}();i.Mesh3DLib=u;var h=function(){function e(e){this.lastPercentage=-1,this.stage=e}return e.prototype.createFigure=function(e,t,r){var n=this;return this.currentFigure=new f(e.readString()),this.currentSceneMesh3DLib&&e.tryReadString(function(e){n.currentFigure.Node=n.currentSceneMesh3DLib.getNodeFromPath(e)}),r.addFigure(this.currentFigure),!0},e.prototype.createMesh=function(e,t,r){var n=!1;return this.currentShaderInstance=function i(e){var t,r=null;return e.tryReadString(function(e){t=e})&&("OpaqueMeshShader"==t||"TransparentMeshShader"==t?r=new a(t):"TexturedMeshShader"==t&&(r=new c(t)),r&&r.construct(e)),r}(e),this.currentShaderInstance&&this.currentFigure&&(this.currentFigure.addShaderInstance(this.currentShaderInstance),n=!0),n},e.prototype.createMeshBuffer=function(e,t,r){for(var n=new g(e,"VertexBuffer",!1),i=n.BufferID,o=1;r.getBufferAsset(i);)i=n.BufferID+o++;n.BufferID=i,r.addBufferAsset(i,n),this.currentShaderInstance&&this.currentFigure,n.initialize(t),this.currentShaderInstance&&this.currentShaderInstance.addReference("VertexBuffer",n.BufferID)},e.prototype.createMeshIndicesBuffer=function(e,t,r){for(var n=new g(e,"IndexBuffer",!0),i=n.BufferID,o=1;r.getBufferAsset(i);)i=n.BufferID+o++;n.BufferID=i,r.addBufferAsset(i,n),n.initialize(t),this.currentShaderInstance&&this.currentShaderInstance.addReference("IndexBuffer",n.BufferID)},e.prototype.createTexture=function(e,t,r,n){var i,o,s=this;if(e.tryReadString(function(e){i=e})&&e.tryReadInt64(function(e){o=e})){var a=e.readBytes(o),c="jpeg";".png"==i.substr(i.lastIndexOf(".")).toLowerCase()&&(c="png");var u=new Blob([a],{type:"image/"+c}),h=URL.createObjectURL(u),l=new Image,p=ne.Deferred();n.push(p),l.onload=function(){s.stage.AssetStore.addTextureAsset(i,new x(s.stage,l)),p.resolve()},l.onerror=function(){console.error("Error processing texture blob "+i),p.reject()},l.src=h}},e.prototype.createOctree=function(e,t,r){this.currentFigure.setIntersector(p.CreateFromBlockStream(e))},e.prototype.createScene=function(e,t,r){this.currentSceneMesh3DLib=new u(e.readString())},e.prototype.createRootNode=function(e,t,r){if(this.currentSceneMesh3DLib){var n=y.FromBlockStream(e,this.currentSceneMesh3DLib);this.currentSceneMesh3DLib.setRootNode(n),this.stage.AssetStore.addRootNode(n)}},e.prototype.processBlock=function(e,t,r,n,i){"PSScene"==e?this.createScene(t,r,n):"PSFigure"==e?this.createFigure(t,r,n):"PSMesh"==e?this.createMesh(t,r,n):"PSMeshData"==e?this.createMeshBuffer(t,r,n):"PSMeshIndices"==e?this.createMeshIndicesBuffer(t,r,n):"PSTexture"==e?this.createTexture(t,r,n,i):"PSMeshOctree"==e?this.createOctree(t,r,n):"PSRootNode"==e&&this.createRootNode(t,r,n)},e.prototype.loadFromArrayBuffer=function(e){var t=[],r=this.stage.AssetStore,n=new s(e);try{for(var i=n.enterBlock();i.success;)this.processBlock(i.descriptor.BlockType,n,this.stage,r,t),n.leaveBlock(),i=n.enterBlock()}catch(o){console.log(JSON.stringify(o))}return ne.when.apply(ne,t)},e.prototype.getFromUrl=function(e){var r=this,n=ne.Deferred(),t=new XMLHttpRequest;return t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(e){r.loadFromArrayBuffer(t.response).done(function(){n.resolve(!0)})},t.onerror=function(e){n.reject(e)},t.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;r.lastPercentage!=Math.floor(100*t)&&(r.lastPercentage=Math.floor(100*t),n.notify(Math.round(100*t)))}}),t.send(null),n},e}();i.AssetFactoryWebGL=h,i.Intersector=function $(){};var l=function(){function e(e){this.boundingBox=e}return e.prototype.getBoundingBox=function(){return this.boundingBox},e}();i.BoundingBoxIntersector=l;var p=function(){function c(){this.boundingBox=new te.psgeometry.AABB3D}return c.CreateFromBlockStream=function(e){var t,r,n,i,o,s,a=new c;return e.tryReadInt(function(e){})&&e.tryReadFloat(function(e){return t=e})&&e.tryReadFloat(function(e){return r=e})&&e.tryReadFloat(function(e){return n=e})&&e.tryReadFloat(function(e){return i=e})&&e.tryReadFloat(function(e){return o=e})&&e.tryReadFloat(function(e){return s=e})&&(a.boundingBox.addPoint(t,r,n),a.boundingBox.addPoint(i,o,s)),a},c.prototype.getBoundingBox=function(){return this.boundingBox},c}();i.Octree=p;var f=function(){function e(e){this.shaderInstances=[],this.figureID=e}return Object.defineProperty(e.prototype,"Node",{get:function(){return this.node},set:function(e){this.node=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"FigureID",{get:function(){return this.figureID},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShaderInstances",{get:function(){return this.shaderInstances},enumerable:!0,configurable:!0}),e.prototype.getBoundingBox=function(){return this.intersector?this.Node?this.intersector.getBoundingBox().transform(this.Node.AbsoluteTransformation):this.intersector.getBoundingBox():new te.psgeometry.AABB3D},e.prototype.addShaderInstance=function(e){this.shaderInstances.push(e)},e.prototype.render=function(r){var n=this,i=r.Stage;this.shaderInstances.forEach(function(e){e.FigureID=n.figureID;var t=i.getShaderProgram(r,e.ShaderKey);t&&(r.ShaderProgram=t,r.NodeTransform=n.Node?n.Node.AbsoluteTransformation:null,t.render(r,e))})},e.prototype.setIntersector=function(e){this.intersector=e},e.prototype.intersectsBoundingBox=function(e,t){var r=!1;if(this.intersector){var n=this.intersector.getBoundingBox().intersectsRay(e);n&&(t.assignVec(n),r=!0)}return r},e}();i.FigureWebGL=f;var d=function(){function e(){}return e.FromBlockStream=function(e,t){return null},e}();i.AnimationTransformation=d;var y=function(){function o(){this.childNodes={}}return Object.defineProperty(o.prototype,"Name",{get:function(){return this.name},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"AbsoluteTransformation",{get:function(){return this.absoluteTransformation},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"LocalTransformation",{get:function(){return this.localTransformation},enumerable:!0,configurable:!0}),o.prototype.getChildNodeFromPath=function(e){for(var t in this.childNodes)if(e==this.childNodes[t].Name)return this.childNodes[t];for(var t in this.childNodes)if(e.substring(0,this.childNodes[t].Name.length)==this.childNodes[t].Name)return this.childNodes[t].getChildNodeFromPath(e.substr(this.childNodes[t].Name.length));return null},o.FromBlockStream=function(e,t,r){var n=new o;return n.name=e.readString(),n.localTransformation=e.readMatrix4(),n.absoluteTransformation=o.calculateAbsoluteTransformation(n.localTransformation,r),n.parentNode=r,n.readChildNodes(e,t),n.readAnimationTransformations(e,t),n},o.calculateAbsoluteTransformation=function(e,t){return t?e.multiply(t.AbsoluteTransformation):e},o.prototype.readChildNodes=function(r,n){var i=this;r.tryReadInt(function(e){for(var t=0;t<e;++t)i.addChildNode(o.FromBlockStream(r,n,i))})},o.prototype.readAnimationTransformations=function(r,n){var i=this;r.tryReadInt(function(e){for(var t=0;t<e;++t)i.addAnimationTransformation(d.FromBlockStream(r,n))})},o.prototype.addChildNode=function(e){this.childNodes[e.Name]=e},o.prototype.addAnimationTransformation=function(e){},o}();i.NodeAsset=y;var g=function(){function e(e,t,r){if(this.bufferSize=0,this.isElementBuffer=!1,this.bufferID=t,this.isElementBuffer=r,e){var n=e.CurrentBlockDescriptor;n&&(1<n.MajorVersion&&(this.bufferID=e.readString()),this.bufferSize=e.remainingBytesInBlock(),this.bufferData=e.readBytes(this.bufferSize))}}return Object.defineProperty(e.prototype,"BufferID",{get:function(){return this.bufferID},set:function(e){this.bufferID=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Buffer",{get:function(){return this.webGLBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"BufferSize",{get:function(){return this.bufferSize},set:function(e){this.bufferSize=e},enumerable:!0,configurable:!0}),e.prototype.initialize=function(e){this.webGLBuffer=e.gl.createBuffer(),this.isElementBuffer?(e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.webGLBuffer),e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,this.bufferData,e.gl.STATIC_DRAW)):(e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.webGLBuffer),e.gl.bufferData(e.gl.ARRAY_BUFFER,this.bufferData,e.gl.STATIC_DRAW))},e.prototype.bind=function(e){this.isElementBuffer?e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.webGLBuffer):e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.webGLBuffer)},e.prototype.bindInterleaved=function(e,t,r,n,i){0<=t&&(e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.webGLBuffer),e.gl.enableVertexAttribArray(t),e.gl.vertexAttribPointer(t,r,e.gl.FLOAT,!1,n,i))},e}();i.BufferAssetWebGL=g;var m=function(){function e(){this.vertices=[],this.indices=[]}return e.prototype.addTri=function(e,t,r,n,i,o,s,a,c,u,h,l,p){this.vertices.push(e,t,r,0,0,1,u,h,l,n,i,o,0,0,1,u,h,l,s,a,c,0,0,1,u,h,l);var f=this.indices.length;this.indices.push(f,f+1,f+2),p&&(this.vertices.push(n,i,o,0,0,1,u,h,l,e,t,r,0,0,1,u,h,l,s,a,c,0,0,1,u,h,l),f=this.indices.length,this.indices.push(f,f+1,f+2))},e.prototype.addQuad=function(e,t,r,n,i,o,s,a,c,u,h,l,p,f,d,y){this.addTri(e,t,r,n,i,o,s,a,c,p,f,d,y),this.addTri(e,t,r,s,a,c,u,h,l,p,f,d,y)},e.prototype.addStroke=function(e,t,r,n,i,o,s,a,c){var u=new te.psgeometry.Vec3(n,i,o).sub(new te.psgeometry.Vec3(e,t,r)),h=u.norm(),l=Math.atan2(-u.z,u.x),p=Math.asin(u.y/h),f=te.psgeometry.Matrix4.FromRotation(l,p,0).multiply(new te.psgeometry.Vec4(0,.01,0,1)),d=te.psgeometry.Matrix4.FromRotation(l,p,0).multiply(new te.psgeometry.Vec4(0,0,.01,1));this.addQuad(e+f.x-d.x,t+f.y-d.y,r+f.z-d.z,n+f.x-d.x,i+f.y-d.y,o+f.z-d.z,n-f.x-d.x,i-f.y-d.y,o-f.z-d.z,e-f.x-d.x,t-f.y-d.y,r-f.z-d.z,s,a,c),this.addQuad(e-f.x+d.x,t-f.y+d.y,r-f.z+d.z,n-f.x+d.x,i-f.y+d.y,o-f.z+d.z,n+f.x+d.x,i+f.y+d.y,o+f.z+d.z,e+f.x+d.x,t+f.y+d.y,r+f.z+d.z,s,a,c),this.addQuad(e-f.x-d.x,t-f.y-d.y,r-f.z-d.z,n-f.x-d.x,i-f.y-d.y,o-f.z-d.z,n-f.x+d.x,i-f.y+d.y,o-f.z+d.z,e-f.x+d.x,t-f.y+d.y,r-f.z+d.z,s,a,c),this.addQuad(e+f.x+d.x,t+f.y+d.y,r+f.z+d.z,n+f.x+d.x,i+f.y+d.y,o+f.z+d.z,n+f.x-d.x,i+f.y-d.y,o+f.z-d.z,e+f.x-d.x,t+f.y-d.y,r+f.z-d.z,s,a,c)},e.prototype.initialize=function(e){var t=new Float32Array(this.vertices.length);t.set(this.vertices),this.vertBufferAsset.bufferData=t.buffer,this.vertBufferAsset.BufferSize=9*this.indices.length*4;var r=new Int32Array(this.indices.length);r.set(this.indices),this.indBufferAsset.bufferData=r.buffer,this.vertBufferAsset.initialize(e),this.indBufferAsset.initialize(e)},e.prototype.createFigure=function(e,t){this.indBufferAsset=new i.BufferAssetWebGL(undefined,t+"_indices",!0),this.vertBufferAsset=new i.BufferAssetWebGL(undefined,t+"_vertices",!1),this.initialize(e),e.AssetStore.addBufferAsset(t+"_indices",this.indBufferAsset),e.AssetStore.addBufferAsset(t+"_vertices",this.vertBufferAsset);var r=new i.MeshShaderInstance("OpaqueMeshShader");r.addReference("IndexBuffer",t+"_indices"),r.addReference("VertexBuffer",t+"_vertices");var n=new i.FigureWebGL(t);return n.addShaderInstance(r),n},e}();i.OpaqueMeshBuilder=m;var b=function(){function e(e,t){this.vertBufferAsset=e,this.indBufferAsset=t,this.vertices=[],this.indices=[]}return e.prototype.addTri=function(e,t,r,n,i,o,s,a,c,u,h,l,p,f){this.vertices.push(e,t,r,0,0,1,u,h,l,p,n,i,o,0,0,1,u,h,l,p,s,a,c,0,0,1,u,h,l,p);var d=this.indices.length;this.indices.push(d,d+1,d+2),f&&this.addTri(e,t,r,s,a,c,n,i,o,u,h,l,p)},e.prototype.addQuad=function(e,t,r,n,i,o,s,a,c,u,h,l,p,f,d,y,g){this.addTri(e,t,r,n,i,o,s,a,c,p,f,d,y,g),this.addTri(e,t,r,s,a,c,u,h,l,p,f,d,y,g)},e.prototype.initialize=function(e){var t=new Float32Array(this.vertices.length);t.set(this.vertices),this.vertBufferAsset.bufferData=t.buffer,this.vertBufferAsset.BufferSize=10*this.indices.length*4;var r=new Int32Array(this.indices.length);r.set(this.indices),this.indBufferAsset.bufferData=r.buffer,this.vertBufferAsset.initialize(e),this.indBufferAsset.initialize(e)},e}();i.TransparentMeshBuilder=b;var v=function(){function e(e,t){this.vertBufferAsset=e,this.indBufferAsset=t,this.vertices=[],this.indices=[]}return e.prototype.addTri=function(e,t,r,n,i,o,s,a,c,u,h,l,p,f,d,y,g,m,b){this.vertices.push(e,t,r,0,0,1,y,g,m,n,i,o,s,a,0,0,1,y,g,m,c,u,h,l,p,0,0,1,y,g,m,f,d);var v=this.indices.length;this.indices.push(v,v+1,v+2),b&&this.addTri(e,t,r,n,i,h,l,p,f,d,o,s,a,c,u,y,g,m)},e.prototype.addQuad=function(e,t,r,n,i,o,s,a,c,u,h,l,p,f,d,y,g,m,b,v,x,w,S,I){this.addTri(e,t,r,n,i,o,s,a,c,u,h,l,p,f,d,x,w,S,I),this.addTri(e,t,r,n,i,h,l,p,f,d,y,g,m,b,v,x,w,S,I)},e.prototype.initialize=function(e){var t=new Float32Array(this.vertices.length);t.set(this.vertices),this.vertBufferAsset.bufferData=t.buffer,this.vertBufferAsset.BufferSize=11*this.indices.length*4;var r=new Int32Array(this.indices.length);r.set(this.indices),this.indBufferAsset.bufferData=r.buffer,this.vertBufferAsset.initialize(e),this.indBufferAsset.initialize(e)},e}();i.TexturedMeshBuilder=v;var x=function(){function e(e,t){t instanceof WebGLTexture?this.texture=t:(this.texture=e.gl.createTexture(),e.gl.bindTexture(e.gl.TEXTURE_2D,this.texture),e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,e.gl.UNSIGNED_BYTE,t),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,e.gl.LINEAR_MIPMAP_NEAREST),e.gl.generateMipmap(e.gl.TEXTURE_2D),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}return e.prototype.bind=function(e,t,r){e.gl.activeTexture(e.gl.TEXTURE0),e.gl.uniform1i(e.gl.getUniformLocation(t.Program,r),0),e.gl.bindTexture(e.gl.TEXTURE_2D,this.texture)},e.prototype.unbind=function(e,t,r){e.gl.activeTexture(e.gl.TEXTURE0),e.gl.bindTexture(e.gl.TEXTURE_2D,null)},e}();i.TextureAssetWebGL=x;var w=function(){function e(){this.figures={},this.rootNodeAssets={},this.bufferAssets={},this.textureAssets={}}return e.prototype.addFigure=function(e){this.figures[e.FigureID]=e},e.prototype.getFigure=function(e){return this.figures[e]},e.prototype.addBufferAsset=function(e,t){this.bufferAssets[e]=t},e.prototype.addRootNode=function(e){this.rootNodeAssets[e.Name]=e},e.prototype.getBufferAsset=function(e){return this.bufferAssets[e]},e.prototype.addTextureAsset=function(e,t){this.textureAssets[e]=t},e.prototype.getTextureAsset=function(e){return this.textureAssets[e]},Object.defineProperty(e.prototype,"Figures",{get:function(){return this.figures},enumerable:!0,configurable:!0}),e.prototype.getRootNode=function(e){return this.rootNodeAssets[e]},e}();i.AssetStoreWebGL=w,i.SceneItemFilterWebGL=function ee(){};var S=function(){function e(){}return e.prototype.passes=function(e,t){return"Shadow"!=t.Phase},e}();i.GenericSceneItemFilterWebGL=S;var I=function(){function e(e,t,r,n,i,o){this.children=[],this.childrenByKey={},this.data={},this.scene=e,this.sceneItemID=t,this.isVisible=r||void 0===r,this.childrenVisible=i||void 0===i,this.testIntersection=n||void 0===n,this.testChildrenIntersection=o||void 0===o}return Object.defineProperty(e.prototype,"Data",{get:function(){return this.data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Scene",{get:function(){return this.scene},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"SceneItemID",{get:function(){return this.sceneItemID},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Children",{get:function(){return this.children},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"TestChildrenIntersection",{get:function(){return this.testChildrenIntersection},set:function(e){this.testChildrenIntersection=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"TestIntersection",{get:function(){return this.testIntersection},set:function(e){this.testIntersection=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Filter",{get:function(){return this.filter},set:function(e){this.filter=e},enumerable:!0,configurable:!0}),e.prototype.addChild=function(e){this.childrenByKey[e.sceneItemID]=e,this.children.push(e),e.addedToSceneGraph(this)},e.prototype.getChild=function(e){return this.childrenByKey[e]},e.prototype.removeChild=function(t){this.children=this.children.filter(function(e){return e.sceneItemID!=t}),delete this.childrenByKey[t]},e.prototype.insertChild=function(e,t){this.childrenByKey[e.sceneItemID]=e,this.children.splice(t,0,e),e.addedToSceneGraph(this)},e.prototype.beginRender=function(e){},e.prototype.endRender=function(e){},e.prototype.render=function(e){this.filter&&!this.filter.passes(this,e)||(this.isVisible?(this.beginRender(e),this.renderChildren(e),this.endRender(e)):this.renderChildren(e))},e.prototype.renderChildren=function(t){this.childrenVisible&&this.children.forEach(function(e){e.render(t)})},e.prototype.addedToSceneGraph=function(e){this.scene=e.scene,this.parent=e},e.prototype.intersectsBoundingBox=function(e,t){return!1},e.prototype.isIntersectionCandidate=function(e,t){return this.intersectsBoundingBox(e,t)},e.prototype.addIntersectionCandidates=function(e,t){if(this.testIntersection){var r=new te.psgeometry.Vec3;this.isIntersectionCandidate(e,r)&&t.push(new M(this,r.squaredDist(e.p0.asVec3())))}if(this.testChildrenIntersection)for(var n in this.children)this.children[n].addIntersectionCandidates(e,t)},e}(),A=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.figures=[],r.state=new T,r}return ie(e,n),Object.defineProperty(e.prototype,"State",{get:function(){return this.state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Figures",{get:function(){return this.figures},enumerable:!0,configurable:!0}),e.prototype.addFigure=function(e){this.figures.push(e)},e.prototype.beginRender=function(t){this.figures.forEach(function(e){e.render(t)})},e.prototype.intersectsBoundingBox=function(e,t){var r=this.inverseModelTransform?e.transform(this.inverseModelTransform):e,n=!1;for(var i in this.figures)n||(n=this.figures[i].intersectsBoundingBox(r,t))&&t.assignVec(this.lastModelTransform.multiply(t.asVec4()));return n},e.prototype.render=function(e){if((!this.filter||this.filter.passes(this,e))&&(this.isVisible||this.childrenVisible)){e.pushState(this.state),this.isVisible?(this.beginRender(e),this.renderChildren(e),this.endRender(e)):this.renderChildren(e);var t=e.NodeTransform?e.NodeTransform.multiply(e.ModelTransform):e.ModelTransform;t.equals(this.lastModelTransform)||(this.inverseModelTransform=t.inverse(),this.lastModelTransform=t),e.popState()}},e}(i.SceneItemWebGL=I);i.ActorWebGL=A;var M=function(){function e(e,t){this.squaredDist=Infinity,this.sceneItem=e,this.squaredDist=t}return e.prototype.compare=function(e){return this.squaredDist<e.squaredDist?-1:this.squaredDist>e.squaredDist?1:0},e}();i.IntersectionCandidate=M;var T=function(){function e(){this.entries={}}return Object.defineProperty(e.prototype,"Parent",{get:function(){return this.parent},set:function(e){this.parent=e},enumerable:!0,configurable:!0}),e.prototype.evaluate=function(e){return"function"==typeof e?e(this):e},e.prototype.contains=function(e){return this.entries[e]!=undefined},e.prototype.get=function(e,t){var r=t;return this.tryGet(e,function(e){r=e}),r},e.prototype.tryGet=function(e,t){return this.contains(e)?(t(this.evaluate(this.entries[e])),!0):null!=this.parent&&this.parent.tryGet(e,t)},e.prototype.set=function(e,t){this.entries[e]=t},e}();i.RenderState=T;var P=function(){function e(){this.isInitialized=!1,this.sceneHierarchy=new I(this,""),this.dirty=!0,this.state=new T}return Object.defineProperty(e.prototype,"SceneHierarchy",{get:function(){return this.sceneHierarchy},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"IsInitialized",{get:function(){return this.isInitialized},set:function(e){this.isInitialized=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"State",{get:function(){return this.state},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){},e.prototype.setDirty=function(){this.dirty=!0},e.prototype.isDirty=function(){return!!this.dirty&&!(this.dirty=!1)},e.prototype.render=function(e){this.isInitialized&&(e.SceneCategory=this.getSceneCategory(),e.pushState(this.state),this.sceneHierarchy.render(e),e.popState())},e.prototype.addSceneItem=function(e,t){this.sceneHierarchy.addChild(e),this.setDirty()},e.prototype.getSceneItem=function(e){return this.sceneHierarchy.getChild(e)},e.prototype.removeSceneItem=function(e){this.sceneHierarchy.removeChild(e),this.setDirty()},e.prototype.insertSceneItem=function(e,t,r){this.sceneHierarchy.insertChild(e,t),this.setDirty()},e.prototype.getSceneCategory=function(){return""},e.prototype.getIntersectionCandidates=function(e,t){this.sceneHierarchy.addIntersectionCandidates(e,t),t.sort(function(e,t){return e.compare(t)})},e.prototype.beginFrame=function(){},e.prototype.update=function(){},e.prototype.endFrame=function(){},e}();i.SceneWebGL=P;var C=function(){function e(){this.dirty=!0}return Object.defineProperty(e.prototype,"ProjectionMatrix",{get:function(){return this.projectionMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ViewMatrix",{get:function(){return this.viewMatrix},enumerable:!0,configurable:!0}),e.prototype.setDirty=function(){this.dirty=!0},e.prototype.isDirty=function(){return!!this.dirty&&!(this.dirty=!1)},e.prototype.createViewMatrix=function(e,t,r){var n=e.sub(t).normalize(),i=r.cross(n).normalize(),o=n.cross(i).normalize(),s=new te.psgeometry.Matrix4([i.x,i.y,i.z,0,o.x,o.y,o.z,0,n.x,n.y,n.z,0,0,0,0,1]);return new te.psgeometry.Matrix4([1,0,0,-e.x,0,1,0,-e.y,0,0,1,-e.z,0,0,0,1]).multiply(s)},e.prototype.createPerspectiveMatrix=function(e,t,r,n){var i=r*Math.tan(e*Math.PI/360),o=-i,s=o*t,a=i*t;return this.makeFrustum(s,a,o,i,r,n)},e.prototype.createOrthographicMatrix=function(e,t,r,n,i,o){return new te.psgeometry.Matrix4([2/(t-e),0,0,0,0,2/(n-r),0,0,0,0,2/(i-o),0,(e+t)/(e-t),(r+n)/(r-n),(i+o)/(i-o),1])},e.prototype.makeFrustum=function(e,t,r,n,i,o){var s=2*i/(t-e),a=2*i/(n-r),c=(t+e)/(t-e),u=(n+r)/(n-r),h=-(o+i)/(o-i),l=-2*o*i/(o-i);return new te.psgeometry.Matrix4([s,0,c,0,0,a,u,0,0,0,h,l,0,0,-1,0])},e}(),D=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.shadowMapWidth=1024,e.shadowMapHeight=1024,e}return ie(e,t),e.prototype.resize=function(e){this.projectionMatrix=this.createOrthographicMatrix(-5,5,-5,5,-30,30),this.update(new te.psgeometry.Vec3(0,10,0),new te.psgeometry.Vec3(0,0,0),new te.psgeometry.Vec3(0,0,-1)),this.shadowFramebuffer=e.gl.createFramebuffer(),this.shadowDepthTexture=e.gl.createTexture(),this.renderBuffer=e.gl.createRenderbuffer();var t=new x(e,this.shadowDepthTexture);e.AssetStore.addTextureAsset("Shadow",t),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,this.shadowFramebuffer),e.gl.bindTexture(e.gl.TEXTURE_2D,this.shadowDepthTexture),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,e.gl.LINEAR),e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,this.shadowMapWidth,this.shadowMapHeight,0,e.gl.RGBA,e.gl.UNSIGNED_BYTE,null),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,this.renderBuffer),e.gl.renderbufferStorage(e.gl.RENDERBUFFER,e.gl.DEPTH_COMPONENT16,this.shadowMapWidth,this.shadowMapHeight),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,this.shadowDepthTexture,0),e.gl.framebufferRenderbuffer(e.gl.FRAMEBUFFER,e.gl.DEPTH_ATTACHMENT,e.gl.RENDERBUFFER,this.renderBuffer),e.gl.bindTexture(e.gl.TEXTURE_2D,null),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,null)},e.prototype.updateShadowArea=function(e){var t=e.center(),r=e.extents();this.projectionMatrix=this.createOrthographicMatrix(-r.x/2,r.x/2,-r.y/2,r.y/2,-30,30),this.update(new te.psgeometry.Vec3(t.x,10,t.y),new te.psgeometry.Vec3(t.x,0,t.y),new te.psgeometry.Vec3(0,0,-1)),this.setDirty()},e.prototype.update=function(e,t,r){this.viewMatrix=this.createViewMatrix(e,t,r),this.setDirty()},e.prototype.beginRender=function(e){e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,this.shadowFramebuffer),e.gl.viewport(0,0,this.shadowMapWidth,this.shadowMapHeight),e.gl.clearColor(.2,.2,.2,0),e.gl.clearDepth(0),e.gl.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.gl.enable(e.gl.DEPTH_TEST),e.gl.enable(e.gl.CULL_FACE),e.gl.frontFace(e.gl.CCW),e.gl.cullFace(e.gl.BACK),e.gl.depthFunc(e.gl.GEQUAL)},e.prototype.endRender=function(e){},e}(i.Camera=C);i.ShadowCameraWebGL=D;var R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.clientWidth=1,e.clientHeight=1,e}return ie(e,t),Object.defineProperty(e.prototype,"ProjectionMatrix",{get:function(){return this.projectionMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ViewMatrix",{get:function(){return this.viewMatrix},enumerable:!0,configurable:!0}),e.prototype.resize=function(e){var t=window.devicePixelRatio||1;this.clientWidth=e.gl.canvas.clientWidth,this.clientHeight=e.gl.canvas.clientHeight;var r=Math.floor(e.gl.canvas.clientWidth*t),n=Math.floor(e.gl.canvas.clientHeight*t);e.gl.canvas.width=r/t,e.gl.canvas.height=n/t,this.projectionMatrix=this.createPerspectiveMatrix(45,e.gl.canvas.clientWidth/e.gl.canvas.clientHeight,.1,200),this.inverseProjectionMatrix=this.projectionMatrix.inverse(),this.setDirty()},e.prototype.update=function(e,t,r){this.currentCameraPos=e,this.viewMatrix=this.createViewMatrix(e,t,r),this.inverseViewMatrix=this.viewMatrix.inverse(),this.setDirty()},e.prototype.beginRender=function(e){e.gl.viewport(0,0,e.gl.canvas.clientWidth,e.gl.canvas.clientHeight),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.gl.clearColor(.3,.3,.3,1),e.gl.clearDepth(1),e.gl.clear(e.gl.DEPTH_BUFFER_BIT),e.gl.enable(e.gl.DEPTH_TEST),e.gl.enable(e.gl.CULL_FACE),e.gl.frontFace(e.gl.CCW),e.gl.cullFace(e.gl.BACK),e.gl.depthFunc(e.gl.LEQUAL)},e.prototype.endRender=function(e){},e.prototype.getViewRay=function(e,t){var r=new te.psgeometry.Vec4(e/this.clientWidth*2-1,1-t/this.clientHeight*2,-1,1),n=this.inverseProjectionMatrix.multiply(r);n.w=1;var i=this.inverseViewMatrix.multiply(n);return new te.psgeometry.Line3D(this.currentCameraPos,i)},e}(C);i.CameraWebGL=R;var B=function(){function e(){this.isInitialized=!1,this.SIZE_OF_FLOAT=4}return Object.defineProperty(e.prototype,"Program",{get:function(){return this.program},enumerable:!0,configurable:!0}),e.prototype.render=function(e,t){this.isInitialized&&this.beginRender(e,t)&&(e.Stage.applyState(e),this.internalRender(e,t),this.endRender(e,t))},e.prototype.getAttribLocation=function(e,t){return e.gl.getAttribLocation(this.program,t)},e.prototype.beginRender=function(e,t){return e.Stage.gl.useProgram(this.program),!0},e.prototype.internalRender=function(e,t){},e.prototype.endRender=function(e,t){},e.prototype.initialize=function(e){this.vertexShader=e.Tools.createShader(e.gl.VERTEX_SHADER,this.getVertexShaderSrc()),this.fragmentShader=e.Tools.createShader(e.gl.FRAGMENT_SHADER,this.getFragmentShaderSrc()),this.program=e.gl.createProgram(),e.gl.attachShader(this.program,this.vertexShader),e.gl.attachShader(this.program,this.fragmentShader),e.gl.linkProgram(this.program),e.gl.detachShader(this.program,this.vertexShader),e.gl.detachShader(this.program,this.fragmentShader),console.log(e.gl.getProgramInfoLog(this.program)),this.isInitialized=!0},e.prototype.getVertexShaderSrc=function(){return""},e.prototype.getFragmentShaderSrc=function(){return""},e}(),V=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.getStride=function(){return 9*this.SIZE_OF_FLOAT},t.prototype.internalRender=function(e,t){var r=e.Stage,n=t.getReference("IndexBuffer");if(n){var i=r.AssetStore.getBufferAsset(n);i.bind(r),n=t.getReference("VertexBuffer"),(i=r.AssetStore.getBufferAsset(n)).bindInterleaved(r,this.getAttribLocation(r,"aPosition"),3,this.getStride(),0),i.bindInterleaved(r,this.getAttribLocation(r,"aNormal"),3,this.getStride(),3*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aColor"),3,this.getStride(),6*this.SIZE_OF_FLOAT);var o=i.BufferSize/this.getStride();r.gl.drawElements(r.gl.TRIANGLES,o,r.gl.UNSIGNED_INT,0)}},t.prototype.getVertexShaderSrc=function(){return"uniform mat4 uMMatrix;\n                uniform mat4 uVMatrix;\n                uniform mat4 uPMatrix;\n\n                attribute vec3 aPosition;\n                attribute vec3 aNormal;\n                attribute vec3 aColor;\n\n                varying mediump vec4 vColor;\n\n                void main()\n                {\n                   gl_Position = uPMatrix * uVMatrix * uMMatrix * vec4(aPosition, 1.0);\n                   vec3 normal = aNormal;\n                   vec4 diffuseColor = vec4(aColor, 1.0);\n                   vec4 ambientColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n                   vec3 lightDir = vec3(0.9, 0.7, 1.0);\n                   mediump float lightIntensity = clamp(dot(normalize(normal), normalize(lightDir)), 0.0, 1.0);\n\n                   vColor = vec4((aColor * 0.65 + ambientColor.rgb * 0.35)*(0.7 + lightIntensity * 0.3), 1.0);\n                }"},t.prototype.getFragmentShaderSrc=function(){return"varying mediump vec4 vColor;\n\n                void main()\n                {\n                   gl_FragColor = vColor;\n                }"},t}(i.ShaderProgramWebGL=B);i.OpaqueMeshShaderProgramWebGL=V;var z,F,E=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.getStride=function(){return 10*this.SIZE_OF_FLOAT},t.prototype.internalRender=function(e,t){var r=e.Stage,n=t.getReference("IndexBuffer");if(n){var i=r.AssetStore.getBufferAsset(n);i.bind(r),n=t.getReference("VertexBuffer"),(i=r.AssetStore.getBufferAsset(n)).bindInterleaved(r,this.getAttribLocation(r,"aPosition"),3,this.getStride(),0),i.bindInterleaved(r,this.getAttribLocation(r,"aNormal"),3,this.getStride(),3*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aColor"),4,this.getStride(),6*this.SIZE_OF_FLOAT),r.gl.enable(r.gl.BLEND),r.gl.blendFunc(r.gl.SRC_ALPHA,r.gl.ONE_MINUS_SRC_ALPHA),r.gl.depthMask(!1);var o=i.BufferSize/this.getStride();r.gl.drawElements(r.gl.TRIANGLES,o,r.gl.UNSIGNED_INT,0),r.gl.depthMask(!0),r.gl.disable(r.gl.BLEND)}},t.prototype.getVertexShaderSrc=function(){return"uniform mat4 uMMatrix;\n                uniform mat4 uVMatrix;\n                uniform mat4 uPMatrix;\n\n                attribute vec3 aPosition;\n                attribute vec3 aNormal;\n                attribute vec4 aColor;\n\n                varying mediump vec4 vColor;\n\n                void main()\n                {\n                   gl_Position = uPMatrix * uVMatrix * uMMatrix * vec4(aPosition, 1.0);\n                   vec3 normal = aNormal;\n                   vec4 diffuseColor = aColor;\n                   vec4 ambientColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n                   vec3 lightDir = vec3(0.9, 0.7, 1.0);\n                   mediump float lightIntensity = clamp(dot(normalize(normal), normalize(lightDir)), 0.0, 1.0);\n\n                   vColor = vec4((aColor.rgb * 0.65 + ambientColor.rgb * 0.35)*(0.7 + lightIntensity * 0.3), aColor.a);\n                }"},t.prototype.getFragmentShaderSrc=function(){return"varying mediump vec4 vColor;\n\n                void main()\n                {\n                   gl_FragColor = vColor;\n                }"},t}(B);i.TransparentMeshShaderProgramWebGL=E,(F=z=i.TexturedMeshShaderProgramVariants||(i.TexturedMeshShaderProgramVariants={}))[F.Diffuse=0]="Diffuse",F[F.Matcap=1]="Matcap";var O=function(r){function e(e){void 0===e&&(e=z.Diffuse);var t=r.call(this)||this;return t.variant=e,t}return ie(e,r),e.prototype.getStride=function(){return 11*this.SIZE_OF_FLOAT},e.prototype.internalRender=function(e,t){var r=e.Stage,n=t.getReference("IndexBuffer");if(n){var i=r.AssetStore.getBufferAsset(n);i.bind(r),n=t.getReference("VertexBuffer"),(i=r.AssetStore.getBufferAsset(n)).bindInterleaved(r,this.getAttribLocation(r,"aPosition"),3,this.getStride(),0),i.bindInterleaved(r,this.getAttribLocation(r,"aNormal"),3,this.getStride(),3*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aColor"),3,this.getStride(),6*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aTextureCoords"),2,this.getStride(),9*this.SIZE_OF_FLOAT);var o=t.getReference("TextureBuffer"),s=r.AssetStore.getTextureAsset(o);if(s){s.bind(r,this,"uTexture0");var a=i.BufferSize/this.getStride();r.gl.drawElements(r.gl.TRIANGLES,a,r.gl.UNSIGNED_INT,0)}}},e.prototype.getVertexShaderSrc=function(){var e="uniform mat4 uMMatrix;\n                uniform mat4 uVMatrix;\n                uniform mat4 uPMatrix;\n\n                attribute vec3 aPosition;\n                attribute vec3 aNormal;\n                attribute vec3 aColor;\n                attribute vec2 aTextureCoords;\n\n                varying mediump vec4 vColor;\n                varying mediump vec2 vTextureCoords;\n                varying mediump float vLightIntensity;\n\n                void main()\n                {\n                   vec4 pos = uMMatrix * vec4(aPosition, 1.0);\n                   gl_Position = uPMatrix * uVMatrix * pos;\n                   vec3 normal = normalize(uMMatrix * vec4(aNormal, 0.0)).xyz;\n\n                   vec3 lightDir = vec3(0.9, 0.7, 1.0);\n                   vLightIntensity = clamp(dot(normalize(normal), normalize(lightDir)), 0.0, 1.0);\n\n                   vColor = vec4(aColor, 1.0);\n";switch(this.variant){case z.Diffuse:e+="vTextureCoords = aTextureCoords;\n";break;case z.Matcap:e+="vec3 e = normalize(pos.xyz);\n\t                 vec3 r = reflect(e, (uVMatrix * vec4(normal, 0.0)).xyz);\n\t                 mediump float m = 2. * length(vec3(r.x, r.y, r.z + 1.));\n\t                 vTextureCoords = r.xy / m + .5;\n"}return e+="}"},e.prototype.getFragmentShaderSrc=function(){var e="uniform sampler2D uTexture0;\n\n                varying mediump vec4 vColor;\n                varying mediump vec2 vTextureCoords;\n                varying mediump float vLightIntensity;\n\n                void main()\n                {\n            \t    mediump vec4 texColor = texture2D(uTexture0, vec2(vTextureCoords.x, 1.0 - vTextureCoords.y));\n";switch(this.variant){case z.Diffuse:e+="gl_FragColor = vec4(clamp(texColor.xyz * (1.0 + .15 * vLightIntensity), 0.0, 1.0), texColor.a); \n            ";break;case z.Matcap:e+="gl_FragColor = texColor.a;   \n"}return e+="}"},e}(B),L=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.getVertexShaderSrc=function(){return"uniform mat4 uMMatrix;\n                uniform mat4 uVMatrix;\n                uniform mat4 uPMatrix;\n\n                attribute vec3 aPosition;\n                attribute vec3 aNormal;\n                attribute vec3 aColor;\n                attribute vec2 aTextureCoords;\n\n                varying mediump float height;\n\n                void main()\n                {\n                   gl_Position = uPMatrix * uVMatrix * uMMatrix * vec4(aPosition, 1.0);\n                   height = (uMMatrix * vec4(aPosition, 1.0)).y;\n                }"},t.prototype.getFragmentShaderSrc=function(){return"uniform sampler2D uTexture0;\n                varying mediump float height;\n\n\n                void main()\n                {\n                    gl_FragColor = vec4(.2, .2, .2, clamp(1.0 - (height / 3.0), 0.0, 1.0)); \n                }"},t}(i.TexturedMeshShaderProgramWebGL=O);i.ShadowTexturedMeshShaderProgramWebGL=L;var j=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.getStride=function(){return 11*this.SIZE_OF_FLOAT},t.prototype.internalRender=function(e,t){var r=e.Stage,n=t.getReference("IndexBuffer");if(n){var i=r.AssetStore.getBufferAsset(n);i.bind(r),n=t.getReference("VertexBuffer"),(i=r.AssetStore.getBufferAsset(n)).bindInterleaved(r,this.getAttribLocation(r,"aPosition"),3,this.getStride(),0),i.bindInterleaved(r,this.getAttribLocation(r,"aNormal"),3,this.getStride(),3*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aColor"),3,this.getStride(),6*this.SIZE_OF_FLOAT),i.bindInterleaved(r,this.getAttribLocation(r,"aTextureCoords"),2,this.getStride(),9*this.SIZE_OF_FLOAT);var o=t.getReference("TextureBuffer"),s=r.AssetStore.getTextureAsset(o);if(s){s.bind(r,this,"uTexture0");var a=e.State.get("Color",te.psgeometry.Vec4.One),c=r.gl.getUniformLocation(this.program,"uColor");r.gl.uniform4fv(c,a.elements());var u=i.BufferSize/this.getStride();r.gl.drawElements(r.gl.TRIANGLES,u,r.gl.UNSIGNED_INT,0)}}},t.prototype.getVertexShaderSrc=function(){return"uniform mat4 uMMatrix;\n                uniform mat4 uVMatrix;\n                uniform mat4 uPMatrix;\n\n                attribute vec3 aPosition;\n                attribute vec3 aNormal;\n                attribute vec3 aColor;\n                attribute vec2 aTextureCoords;\n\n                varying mediump vec4 vColor;\n                varying mediump vec2 vTextureCoords;\n\n                void main()\n                {\n                   vec4 pos = uMMatrix * vec4(aPosition, 1.0);\n                   gl_Position = uPMatrix * uVMatrix * pos;\n                   vec3 normal = normalize(uMMatrix * vec4(aNormal, 0.0)).xyz;\n\n                   vec3 e = normalize(pos.xyz);\n\t               vec3 r = reflect(e, (uVMatrix * vec4(normal, 0.0)).xyz);\n\t               mediump float m = 2. * length(vec3(r.x, r.y, r.z + 1.));\n\t               vTextureCoords = r.xy / m + .5;\n                }"},t.prototype.getFragmentShaderSrc=function(){return"uniform sampler2D uTexture0;\n                uniform mediump vec4 uColor;\n\n                varying mediump vec4 vColor;\n                varying mediump vec2 vTextureCoords;\n\n                void main()\n                {\n            \t    mediump vec4 texColor = texture2D(uTexture0, vec2(vTextureCoords.x, 1.0 - vTextureCoords.y));\n                    //mediump vec3 green = vec3(0, 0.44, 0.09);\n                    //mediump vec3 green = vec3(0.69, 0.34, 0.00);  //or\n                    //mediump vec3 green = vec3(0.02, 0.31, 0.06);  // g\n                    //mediump vec3 green = vec3(0.31, 0.02, 0.06);  // r\n                    //mediump vec3 green = vec3(0.02, 0.17, 0.31);  // b\n                    mediump float colorFac = (texColor.x - texColor.y) / 0.65;\n                    mediump float whiteFac = (1.0 - colorFac) * 0.75;\n                    mediump vec3 color = vec3(whiteFac, whiteFac, whiteFac) + colorFac * uColor.rgb;\n\n                    gl_FragColor = vec4(color, texColor.a * uColor.a);   \n            }"},t}(B);i.MatCapShaderProgramWebGL=j;var N=function(){function e(){this.modelTransform=[te.psgeometry.Matrix4.Identity],this.stack=[]}return Object.defineProperty(e.prototype,"Top",{get:function(){return this.stack[this.stack.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CurrentModelTransform",{get:function(){return this.modelTransform[this.modelTransform.length-1]},enumerable:!0,configurable:!0}),e.prototype.pushState=function(e){if(e.Parent=0==this.stack.length?null:this.Top,this.stack.push(e),e.contains("ModelTransform")){var t=e.get("ModelTransform",te.psgeometry.Matrix4.Identity);this.modelTransform.push(this.CurrentModelTransform.multiply(t))}else this.modelTransform.push(this.CurrentModelTransform)},e.prototype.popState=function(){this.Top.Parent=null,this.stack.pop(),this.modelTransform.pop()},e}(),_=function(){function e(){this.sceneCategory="",this.stateStack=new N,this.modelTransform=null,this.nodeTransform=null,this.phase=""}return Object.defineProperty(e.prototype,"Phase",{get:function(){return this.phase},set:function(e){this.phase=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"State",{get:function(){return this.stateStack.Top},enumerable:!0,configurable:!0}),e.prototype.pushState=function(e){this.stateStack.pushState(e)},e.prototype.popState=function(){this.stateStack.popState()},Object.defineProperty(e.prototype,"ModelTransform",{get:function(){return this.stateStack.CurrentModelTransform},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"SceneCategory",{get:function(){return this.sceneCategory},set:function(e){this.sceneCategory=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Stage",{get:function(){return this.stage},set:function(e){this.stage=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Camera",{get:function(){return this.camera},set:function(e){this.camera=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShaderProgram",{get:function(){return this.shaderProgram},set:function(e){this.shaderProgram=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"NodeTransform",{get:function(){return this.nodeTransform},set:function(e){this.nodeTransform=e},enumerable:!0,configurable:!0}),e}();i.RenderContextWebGL=_;var k,W,U=function(){function e(e){var t=this;this.phaseSpecificShaderPrograms={},this.shaderPrograms={},this.tools=new n(this);try{if(this.context=new _,(this.context.Stage=this).assetStore=new w,this.assetFactory=new h(this),this.canvas=document.getElementById(e),this.canvas){this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");this.gl.getExtension("OES_element_index_uint");window.addEventListener("resize",function(){t.resize()})}this.gl||alert("Unable to initialize WebGL. Your browser may not support it.")}catch(r){alert("Unable to initialize WebGL. Your browser may not support it. Error: "+r)}}return Object.defineProperty(e.prototype,"Canvas",{get:function(){return this.canvas},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Camera",{get:function(){return this.camera},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Tools",{get:function(){return this.tools},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"AssetFactory",{get:function(){return this.assetFactory},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"AssetStore",{get:function(){return this.assetStore},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){this.shadowCamera=new D,this.shadowCamera.resize(this),this.camera=new R,this.camera.resize(this),this.resize()},e.prototype.updateShadowArea=function(e){this.shadowCamera.updateShadowArea(e)},e.prototype.applyState=function(e){var t=e.ShaderProgram.Program,r=te.psgeometry.Matrix4.Identity;e.ModelTransform&&e.NodeTransform?r=e.NodeTransform.multiply(e.ModelTransform):e.ModelTransform?r=e.ModelTransform:e.NodeTransform&&(r=e.NodeTransform);var n=this.gl.getUniformLocation(t,"uMMatrix");this.gl.uniformMatrix4fv(n,!1,r.transpose().elements);var i=this.gl.getUniformLocation(t,"uVMatrix");this.gl.uniformMatrix4fv(i,!1,e.Camera.ViewMatrix.transpose().elements);var o=this.gl.getUniformLocation(t,"uPMatrix");this.gl.uniformMatrix4fv(o,!1,e.Camera.ProjectionMatrix.transpose().elements)},e.prototype.render=function(e){(e.isDirty()||this.camera.isDirty()||this.shadowCamera.isDirty())&&(this.context.Phase="Shadow",this.context.Camera=this.shadowCamera,this.shadowCamera.beginRender(this),e.render(this.context),this.shadowCamera.endRender(this),this.context.Phase="",this.context.Camera=this.camera,this.camera.beginRender(this),e.render(this.context),this.camera.endRender(this))},e.prototype.registerShaderProgram=function(e,t){this.shaderPrograms[e]=t},e.prototype.registerPhaseSpecificShaderProgram=function(e,t,r){var n=this.phaseSpecificShaderPrograms[e];n||(n={},this.phaseSpecificShaderPrograms[e]=n),n[t]=r},e.prototype.getShaderProgram=function(e,t){var r;if(e.phase){var n=this.phaseSpecificShaderPrograms[e.phase];n&&(r=n[t])}return r||this.shaderPrograms[t]},e.prototype.resize=function(){this.canvas.width=this.canvas.parentElement.offsetWidth,this.canvas.height=this.canvas.parentElement.offsetHeight,this.camera.resize(this)},e}();i.StageWebGL=U,(W=k=i.ConnectionState||(i.ConnectionState={}))[W.Ready=0]="Ready",W[W.Connecting=1]="Connecting",W[W.Connected=2]="Connected",W[W.Error=3]="Error";var X=function(){function e(){this.state=k.Ready}return Object.defineProperty(e.prototype,"IsConnected",{get:function(){return this.state==k.Connected},enumerable:!0,configurable:!0}),e.prototype.onMessage=function(e){this.handleMessage=e},e.prototype.onConnected=function(e){this.handleConnected=e},e}(),G=function(e){function t(){var r=e.call(this)||this;return r.connection=(new re.HubConnectionBuilder).withUrl("/api/state").configureLogging(re.LogLevel.Trace).build(),r.connection.on("msg",function(e){if(r.handleMessage){var t=new MessageEvent("binary",{data:e});r.handleMessage(t)}}),r}return ie(t,e),t.prototype.connect=function(){var t=this;this.state=k.Connecting,this.connection.start().then(function(){t.handleConnected&&(t.state=k.Connected,t.handleConnected(new Event("connected")))})["catch"](function(e){t.state=k.Error})},t.prototype.disconnect=function(){var e=this;this.connection.stop().then(function(){e.state=k.Ready})["catch"](function(){e.state=k.Error})},t.prototype.send=function(e){this.connection.invoke("Msg",e)},t}(i.ServerConnection=X);i.SignalRServerConnection=G;var Y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.connect=function(e){var t=this;if(this.state==k.Ready||this.state==k.Error){var r=e||"ws://"+window.location.host+"/api/scene";this.state=k.Connecting,this.websocket=new WebSocket(r),this.websocket.binaryType="arraybuffer",this.websocket.onopen=function(e){t.state=k.Connected,console.log("websocket connected."),t.handleConnected&&t.handleConnected(e)},this.websocket.onclose=function(e){console.log("websocket closed."),t.state=k.Ready},this.websocket.onerror=function(e){t.state=k.Error,console.log("websocket error.")},this.websocket.onmessage=function(e){t.handleMessage&&t.handleMessage(e)}}},t.prototype.disconnect=function(){this.websocket.close()},t.prototype.send=function(e){this.websocket.send(e)},t}(X);i.WebSocketServerConnection=Y;var Z=function(){function e(){}return e.prototype.enter=function(e){this.interfaceController=e},e.prototype.leave=function(){},e.prototype.handleKeyUp=function(e){return!1},e.prototype.handleMouseMove=function(e,t,r){},e.prototype.handleMouseDown=function(e){},e.prototype.handleMouseUp=function(e){},e.prototype.handleDrag=function(e,t,r,n,i){},e.prototype.handleMouseWheel=function(e){},e.prototype.handleClick=function(e,t,r){},e}();i.Tool=Z;var H=function(){function e(){this.tools=[],this.leftButton=0,this.leftButtonDown=!1,this.startX=NaN,this.startY=NaN,this.lastX=NaN,this.lastY=NaN,this.onMove=null,this.onDrag=null,this.onMouseWheel=null}return e.prototype.hasTool=function(){return 0<this.tools.length},Object.defineProperty(e.prototype,"CurrentTool",{get:function(){return this.hasTool()?this.tools[this.tools.length-1]:null},enumerable:!0,configurable:!0}),e.prototype.bindEvents=function(e){var t=this;this.target=e,ne(e).on("mousewheel",function(e){t.mouseWheel(e)}),ne(e).on("mousedown touchstart",function(e){t.mouseDown(e),e.preventDefault()}),e.setCapture?ne(e).on("mousemove touchmove",function(e){t.mouseMove(e)}):ne(document).on("mousemove touchmove",function(e){t.mouseMove(e)}),ne(document).on("mouseup touchend touchcancel",function(e){t.mouseUp(e),e.preventDefault()}),ne(e).on("losecapture",function(e){t.mouseUp(e),e.preventDefault()}),ne(document).on("keyup",function(e){t.keyUp(e)&&e.preventDefault()})},e.prototype.updateLastPosition=function(e){this.lastX=e.clientX,this.lastY=e.clientY},e.prototype.pushTool=function(e){this.CurrentTool&&this.CurrentTool.leave(),this.tools.push(e),e.enter(this)},e.prototype.popTool=function(){0<this.tools.length&&(this.tools[this.tools.length-1].leave(),this.tools.pop()),0<this.tools.length&&this.tools[this.tools.length-1].enter(this)},e.prototype.keyUp=function(e){return!!this.hasTool()&&this.CurrentTool.handleKeyUp(e)},e.prototype.mouseDown=function(e){e.button==this.leftButton&&(this.leftButtonDown=!0,this.startX=e.clientX,this.startY=e.clientY,this.updateLastPosition(e),e.target.setCapture&&e.target.setCapture()),this.hasTool()&&!e.ctrlKey&&this.CurrentTool.handleMouseDown(e)},e.prototype.mouseMove=function(e){this.hasTool()&&!e.ctrlKey?(this.leftButtonDown&&this.CurrentTool.handleDrag(e,this.startX,this.startY,e.clientX-this.lastX,e.clientY-this.lastY),this.CurrentTool.handleMouseMove(e,e.clientX,e.clientY)):this.leftButtonDown?this.drag(e,e.clientX-this.lastX,e.clientY-this.lastY):this.onMove(e,e.clientX,e.clientY),this.leftButtonDown&&this.updateLastPosition(e)},e.prototype.mouseUp=function(e){var t=!1;e.button==this.leftButton&&(t=!(this.leftButtonDown=!1),e.target.releaseCapture&&e.target.releaseCapture()),this.hasTool()&&!e.ctrlKey?this.CurrentTool.handleMouseUp(e):t&&this.updateLastPosition(e)},e.prototype.drag=function(e,t,r){this.onDrag&&this.onDrag(e,t,r)},e.prototype.mouseWheel=function(e){this.hasTool()&&!e.ctrlKey?this.CurrentTool.handleMouseWheel(e):(this.onMouseWheel&&this.onMouseWheel(e),e.preventDefault())},e}();i.InterfaceController=H;var q=function(){function e(e,t,r,n){var i=this;this.radius=20,this.yaw=0,this.pitch=0,this.dragDivisor=100,this.rotateDivisor=200,this.stage=e,this.camera=t,this.connection=n,r.bindEvents(ne(e.Canvas)),r.onDrag=function(e,t,r){i.drag(e,t,r)},r.onMouseWheel=function(e){i.mouseWheel(e)},r.onMove=function(e,t,r){i.move(e,t,r)},this.center=new te.psgeometry.Vec3(0,0,0),this.updateCamera()}return Object.defineProperty(e.prototype,"Yaw",{get:function(){return this.yaw},set:function(e){this.yaw=e,this.updateCamera()},enumerable:!0,configurable:!0}),e.prototype.construct=function(e,t,r){this.radius=e,this.pitch=t,this.yaw=r,this.updateCamera()},e.prototype.mouseWheel=function(e){if(e.shiftKey){var t=this.getViewDir().multiply(e.deltaY||e.deltaX);this.center=this.center.sub(t)}else this.radius+=e.deltaY*Math.log(this.radius+1)/2,this.radius=Math.max(.01,this.radius);this.updateCamera()},e.prototype.move=function(e,t,r){},e.prototype.drag=function(e,t,r){if(e.shiftKey){var n=this.getViewPlaneX(),i=this.getViewPlaneY();this.center=this.center.add(n.multiply(t/this.dragDivisor)).add(i.multiply(r/this.dragDivisor))}else this.yaw-=t/this.rotateDivisor,this.pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.pitch-r/this.rotateDivisor));this.updateCamera()},e.prototype.getViewPlaneX=function(){var e,t,r;return r=new te.psgeometry.Vec3(-1,0,0),e=new te.psgeometry.Quaternion,t=new te.psgeometry.Quaternion,e.setFromAxisAngle(new te.psgeometry.Vec3(0,1,0),this.yaw),t.setFromAxisAngle(new te.psgeometry.Vec3(1,0,0),this.pitch),r=(r=r.applyQuaternion(t)).applyQuaternion(e)},e.prototype.getViewPlaneY=function(){var e,t,r;return r=new te.psgeometry.Vec3(0,1,0),e=new te.psgeometry.Quaternion,t=new te.psgeometry.Quaternion,e.setFromAxisAngle(new te.psgeometry.Vec3(0,1,0),this.yaw),t.setFromAxisAngle(new te.psgeometry.Vec3(1,0,0),this.pitch),r=(r=r.applyQuaternion(t)).applyQuaternion(e)},e.prototype.getViewDir=function(){var e,t,r;return r=new te.psgeometry.Vec3(0,0,-1),e=new te.psgeometry.Quaternion,t=new te.psgeometry.Quaternion,e.setFromAxisAngle(new te.psgeometry.Vec3(0,1,0),this.yaw),t.setFromAxisAngle(new te.psgeometry.Vec3(1,0,0),this.pitch),r=(r=r.applyQuaternion(t)).applyQuaternion(e)},e.prototype.getCameraPos=function(){var e,t,r;return r=new te.psgeometry.Vec3(0,0,this.radius),e=new te.psgeometry.Quaternion,t=new te.psgeometry.Quaternion,e.setFromAxisAngle(new te.psgeometry.Vec3(0,1,0),this.yaw),t.setFromAxisAngle(new te.psgeometry.Vec3(1,0,0),this.pitch),(r=(r=r.applyQuaternion(t)).applyQuaternion(e)).add(this.center)},e.prototype.updateCamera=function(){this.camera.update(this.getCameraPos(),this.center,new te.psgeometry.Vec3(0,1,0))},e}();i.CameraController=q;var Q=function(){function e(){}return e.AppStateDelta=256,e.ServerHandshake=257,e.ClientHandshake=258,e.ClientConfirmation=259,e.AppStateInitialization=260,e.AnchorRequest=510,e.SharedAnchor=511,e}();i.CommonMessageTypes=Q;var K=function(){function r(){this.messageType=Q.AppStateDelta}return Object.defineProperty(r.prototype,"Content",{get:function(){return this.content},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"MessageType",{get:function(){return this.messageType},enumerable:!0,configurable:!0}),r.FromBuffer=function(e){var t=new r;return t.content=e,t},Object.defineProperty(r.prototype,"HasPayload",{get:function(){return this.content.byteLength>r.HeaderSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"PayloadSize",{get:function(){return this.content.byteLength-r.HeaderSize},enumerable:!0,configurable:!0}),r.HeaderSize=8,r}();i.NetworkChannelMessage=K}(te.modelstageweb||(te.modelstageweb={})),function(e){var t=function(){function e(){this.clusterManagers={}}return Object.defineProperty(e.prototype,"LocalPeerID",{get:function(){return this.localPeerID},set:function(e){this.localPeerID=e},enumerable:!0,configurable:!0}),e.prototype.getClusterManager=function(e){return this.clusterManagers[e]},e.prototype.addCluster=function(e,t){this.clusterManagers[e]=t},e.prototype.beginTransaction=function(){for(var e in this.clusterManagers)this.clusterManagers[e].beginTransaction()},e.prototype.endTransaction=function(){for(var e in this.clusterManagers)this.clusterManagers[e].endTransaction()},e.prototype.applyChanges=function(e){for(var t in this.clusterManagers)this.clusterManagers[t].applyChanges(e)},e.prototype.serializeTransaction=function(e){for(var t in this.clusterManagers)this.clusterManagers[t].serializeTransaction(e,t,this)},e.prototype.deserializeTransaction=function(e,t){for(var r=!0;!e.isAtEnd()&&r;){var n=e.readClusterID();if(n){var i=this.clusterManagers[n];r=!!i&&i.deserializeTransaction(e,this,t)}else r=!1}return r},e}(),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.GetInstance=function(){return t.Instance||(t.Instance=new t),t.Instance},t.Instance=null,t}(e.AppStateBase=t);e.AppState=i;var o=function(){function e(){this.buf=[]}return e.prototype.flush=function(){var e=new Uint8Array(this.buf.length);return e.set(this.buf),e},e.prototype.writeByte=function(e){this.buf.push(e)},e.prototype.writeInt16=function(e){this.buf.push(255&e,e>>8&255)},e.prototype.writeUInt16=function(e){this.buf.push(255&e,e>>8&255)},e.prototype.writeInt32=function(e){this.buf.push(255&e,e>>8&255,e>>16&255,e>>24&255)},e.prototype.writeInt64=function(e){this.buf.push(255&e,e>>8&255,e>>16&255,e>>24&255,e>>32&255,e>>40&255,e>>48&255,e>>56&255)},e.prototype.writeTimestamp=function(e){this.writeInt64(e)},e.prototype.writeFloat32=function(e){var t=new ArrayBuffer(4);new DataView(t).setFloat32(0,e,!0);var r=new Int8Array(t);this.buf.push.apply(r)},e.prototype.writeString=function(e){this.writeInt32(e.length),this.writeCharArray(e,e.length)},e.prototype.writeCharArray=function(e,t){for(var r=0;r<t;++r)this.buf.push(r<e.length?e.charCodeAt(r):0)},e.prototype.writeWideCharArray=function(e,t){for(var r=0;r<t;++r)this.buf.push(r<e.length?255&e.charCodeAt(r):0,r<e.length?e.charCodeAt(r)>>8&255:0)},e.prototype.writeVec3=function(e){var t=new ArrayBuffer(12),r=new DataView(t);r.setFloat32(0,e.x,!0),r.setFloat32(4,e.y,!0),r.setFloat32(8,e.z,!0);var n=new Uint8Array(t);this.buf.push.apply(n)},e.prototype.writeVec4=function(e){var t=new ArrayBuffer(16),r=new DataView(t);r.setFloat32(0,e.x,!0),r.setFloat32(4,e.y,!0),r.setFloat32(8,e.z,!0),r.setFloat32(12,e.w,!0);var n=new Uint8Array(t);this.buf.push(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])},e}();e.BinaryWriter=o;var r=function(){function e(e){this.currentPos=8,this.error=!1,this.buf=e}return Object.defineProperty(e.prototype,"Error",{get:function(){return this.error},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"AtEnd",{get:function(){return this.currentPos>=this.buf.byteLength},enumerable:!0,configurable:!0}),e.prototype.assureRemainingBytes=function(e){return this.currentPos+e<=this.buf.byteLength},e.prototype.readByte=function(){return this.assureRemainingBytes(1)?this.buf[this.currentPos++]:(this.error=!0,NaN)},e.prototype.readUInt16=function(){return this.assureRemainingBytes(2)?this.buf[this.currentPos++]+256*this.buf[this.currentPos++]:(this.error=!0,NaN)},e.prototype.readUInt64=function(){return this.assureRemainingBytes(8)?this.buf[this.currentPos++]+256*this.buf[this.currentPos++]+65536*this.buf[this.currentPos++]+16777216*this.buf[this.currentPos++]+4294967296*this.buf[this.currentPos++]+1099511627776*this.buf[this.currentPos++]+281474976710656*this.buf[this.currentPos++]+72057594037927940*this.buf[this.currentPos++]:(this.error=!0,NaN)},e.prototype.readUInt32=function(){return this.assureRemainingBytes(4)?this.buf[this.currentPos++]+256*this.buf[this.currentPos++]+65536*this.buf[this.currentPos++]+16777216*this.buf[this.currentPos++]:(this.error=!0,NaN)},e.prototype.readString=function(){var e=null,t=this.readUInt32();return this.error||(this.assureRemainingBytes(t)?e=this.readCharArray(t):this.error=!0),e},e.prototype.readTimestamp=function(){return this.readUInt64()},e.prototype.readCharArray=function(e){for(var t=[],r=0;r<e&&0!=this.buf[this.currentPos+r]&&!this.error;)this.currentPos<this.buf.byteLength?t.push(this.buf[this.currentPos+r++]):this.error=!0;return this.currentPos+=e,String.fromCharCode.apply(null,t)},e.prototype.readFloat32=function(){var e=NaN;if(this.assureRemainingBytes(4)){var t=new ArrayBuffer(4),r=new DataView(t);r.setUint8(0,this.buf[this.currentPos++]),r.setUint8(1,this.buf[this.currentPos++]),r.setUint8(2,this.buf[this.currentPos++]),r.setUint8(3,this.buf[this.currentPos++]),e=r.getFloat32(0,!0)}else this.error=!0;return e},e.prototype.readVec3=function(){var e=null;if(this.assureRemainingBytes(12)){for(var t=new ArrayBuffer(12),r=new DataView(t),n=0;n<12;++n)r.setUint8(n,this.buf[this.currentPos++]);e=new te.psgeometry.Vec3(r.getFloat32(0,!0),r.getFloat32(4,!0),r.getFloat32(8,!0))}else this.error=!0;return e},e.prototype.readVec4=function(){var e=null;if(this.assureRemainingBytes(16)){for(var t=new ArrayBuffer(16),r=new DataView(t),n=0;n<16;++n)r.setUint8(n,this.buf[this.currentPos++]);e=new te.psgeometry.Vec4(r.getFloat32(0,!0),r.getFloat32(4,!0),r.getFloat32(8,!0),r.getFloat32(12,!0))}else this.error=!0;return e},e}();e.BinaryReader=r;var n=function(){function e(e){this.isInitializing=!1,this.reader=e}return Object.defineProperty(e.prototype,"Reader",{get:function(){return this.reader},enumerable:!0,configurable:!0}),e.prototype.isAtEnd=function(){return this.reader.AtEnd},e.prototype.readClusterID=function(){return this.reader.readString()},Object.defineProperty(e.prototype,"IsInitializing",{get:function(){return this.isInitializing},enumerable:!0,configurable:!0}),e}();e.AppStateDeltaReader=n;var s=function(){function e(e){this.writer=e}return Object.defineProperty(e.prototype,"Writer",{get:function(){return this.writer},enumerable:!0,configurable:!0}),e}();e.AppStateDeltaWriter=s;var a=function(){function e(){this.transactional=!1}return Object.defineProperty(e.prototype,"AppState",{get:function(){return this.appState},set:function(e){this.appState=e},enumerable:!0,configurable:!0}),e.prototype.register=function(e,t){this.key=e,this.cluster=t},e.prototype.reconcile=function(){},e.prototype.setDirty=function(){this.cluster.setDirty()},e.prototype.beginTransaction=function(){this.transactional=!0},e.prototype.endTransaction=function(){this.transactional=!1},e.prototype.isTransactional=function(){return this.transactional},e.prototype.isLocked=function(){return this.cluster.IsLocked},e}(),c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.changedAt=0,e}return ie(e,t),e.prototype.beginChanging=function(){this.changedAt=Date.now(),this.setDirty()},e}(e.AppStateEntry=a),u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.dirty=!1,e}return ie(e,t),e.prototype.set=function(e){e!=this.value&&(this.changing(),this.value=e)},e.prototype.get=function(){return this.value},e.prototype.getPreviousValue=function(){return this.previousValue},e.prototype.changing=function(){this.dirty||this.isLocked()||(this.beginChanging(),this.previousValue=this.value,this.dirty=!0)},e.prototype.isDirty=function(){return this.dirty},e.prototype.beginTransaction=function(){t.prototype.beginTransaction.call(this),this.dirty=!1},e.prototype.deserializeDelta=function(e,t){var r=!1;null!=e.Reader.readTimestamp()&&(null!=e.Reader.readString()&&(this.value=e.Reader.readString(),this.dirty=!0,this.setDirty(),r=!0));return r},e.prototype.serializeDelta=function(e,t){e.Writer.writeString(t),e.Writer.writeTimestamp(this.changedAt),e.Writer.writeString(this.previousValue),e.Writer.writeString(this.value)},e}(e.CommonAppStateEntry=c);e.AppStateStringValue=u;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.dirty=!1,e}return ie(e,t),e.prototype.set=function(e){this.value=e},e.prototype.get=function(){return this.value},e.prototype.isDirty=function(){return this.dirty},e.prototype.beginTransaction=function(){t.prototype.beginTransaction.call(this),this.dirty=!1},e.prototype.deserializeDelta=function(e,t){var r=!1;null!=e.Reader.readTimestamp()&&(null!=this.readValue(e)&&(this.value=this.readValue(e),this.dirty=!0,this.setDirty(),r=!0));return r},e.prototype.serializeDelta=function(e,t){e.Writer.writeString(t),e.Writer.writeTimestamp(this.changedAt),this.writeValue(e,this.previousValue),this.writeValue(e,this.value)},e}(c),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.readValue=function(e){var t=!1;return e.Reader.assureRemainingBytes(1)&&(t=0!=e.Reader.readByte()),t},t.prototype.writeValue=function(e,t){e.Writer.writeByte(t?255:0)},t}(e.AppStateValue=h);e.AppStateBoolValue=l;var p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.readValue=function(e){var t=null;return e.Reader.assureRemainingBytes(16)&&((t=new te.psgeometry.Vec4).x=e.Reader.readFloat32(),t.y=e.Reader.readFloat32(),t.z=e.Reader.readFloat32(),t.w=e.Reader.readFloat32()),t},t.prototype.writeValue=function(e,t){e.Writer.writeFloat32(t.x),e.Writer.writeFloat32(t.y),e.Writer.writeFloat32(t.z),e.Writer.writeFloat32(t.w)},t}(h);e.AppStateVector4Value=p;var f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ie(t,e),t.prototype.readValue=function(e){var t=NaN;return e.Reader.assureRemainingBytes(4)&&(t=e.Reader.readFloat32()),t},t.prototype.writeValue=function(e,t){e.Writer.writeFloat32(t)},t}(h);e.AppStateFloatValue=f;var d,y,g,m,b=function(){function e(e,t){void 0===t&&(t=!0),this.changedAt=e,this.isLocal=t}return Object.defineProperty(e.prototype,"ChangedAt",{get:function(){return this.changedAt},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"IsLocal",{get:function(){return this.isLocal},enumerable:!0,configurable:!0}),e}(),v=function(o){function e(e,t,r,n){void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=!0);var i=o.call(this,e,n)||this;return i.isNewValueDefined=!1,i.isPreviousValueDefined=!1,null!=t&&(i.isNewValueDefined=!0,i.newValue=t),r&&(i.isPreviousValueDefined=!0,i.previousValue=r),i}return ie(e,o),Object.defineProperty(e.prototype,"IsNewValueDefined",{get:function(){return this.isNewValueDefined},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"IsPreviousValueDefined",{get:function(){return this.isPreviousValueDefined},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"NewValue",{get:function(){return this.newValue},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"PreviousValue",{get:function(){return this.previousValue},enumerable:!0,configurable:!0}),e}(e.AppStateOperation=b);e.AppStateValueOperation=v,(y=d=e.OperationType||(e.OperationType={}))[y.Clear=0]="Clear",y[y.Append=1]="Append",y[y.Insert=2]="Insert",y[y.Remove=3]="Remove",y[y.Replace=4]="Replace",(m=g||(g={}))[m.HasPreviousValue=128]="HasPreviousValue",m[m.HasNewValue=64]="HasNewValue",m[m.HasChangedDate=32]="HasChangedDate",m[m.ItemIndex16Bit=16]="ItemIndex16Bit",m[m.None=0]="None",m[m.Mask=240]="Mask";var x=function(a){function e(e,t,r,n,i,o){void 0===r&&(r=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=!0);var s=a.call(this,e,n,i,o)||this;return s.operation=t,s.itemIndex=r,s.reconciledItemIndex=r,s}return ie(e,a),Object.defineProperty(e.prototype,"Operation",{get:function(){return this.operation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ItemIndex",{get:function(){return this.itemIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ReconciledItemIndex",{get:function(){return this.reconciledItemIndex},set:function(e){this.reconciledItemIndex=e},enumerable:!0,configurable:!0}),e}(v);e.AppStateCollectionOperation=x;var w=function(i){function e(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var n=i.call(this)||this;return n.appStateCollectionOperationType=e,n.container=[],n.operations=[],n.serializeOperationChangedAt=t,n.serializePreviousValues=r,n}return ie(e,i),Object.defineProperty(e.prototype,"Operations",{get:function(){return this.operations},enumerable:!0,configurable:!0}),e.prototype.addOperation=function(e){this.isTransactional()?(0==this.operations.length&&this.beginChanging(),this.operations.push(e)):console.error("AppState not transactional while adding operation to AppStateCollection")},e.prototype.clear=function(){this.isLocked()||this.addOperation(new this.appStateCollectionOperationType(this.changedAt,d.Clear)),this.container.length=0},e.prototype.append=function(e){this.isLocked()||this.addOperation(new this.appStateCollectionOperationType(this.changedAt,d.Append,this.container.length,e)),this.container.push(e)},e.prototype.insert=function(e,t){t<=this.container.length?(this.isLocked()||this.addOperation(new this.appStateCollectionOperationType(this.changedAt,d.Insert,t,e)),this.container.splice(t,0,e)):console.error("Index out of range while inserting into AppStateCollection")},e.prototype.remove=function(e){e<this.container.length?(this.isLocked()||this.addOperation(new this.appStateCollectionOperationType(this.changedAt,d.Remove,e,null,this.container[e])),this.container.splice(e,1)):console.error("Index out of range while removing from AppStateCollection")},e.prototype.replace=function(e,t){t<this.container.length?(this.isLocked()||this.addOperation(new this.appStateCollectionOperationType(this.changedAt,d.Replace,t,e,this.container[t])),this.container[t]=e):console.error("Index out of range while replacing item in AppStateCollection")},e.prototype.GetItemAt=function(e){return this.container[e]},Object.defineProperty(e.prototype,"Count",{get:function(){return this.container.length},enumerable:!0,configurable:!0}),e.prototype.isDirty=function(){return 0<this.operations.length},e.prototype.deserializeDelta=function(e,t){var r=e.Reader.readTimestamp(),n=e.Reader.readUInt32(),i=!e.Reader.Error;if(i){0<n&&this.setDirty();for(var o=0;o<n;++o){var s=e.Reader.readByte();if(e.Reader.Error)i=!1;else{var a=s&g.Mask,c=s&~g.Mask,u=r,h=0,l=void 0,p=void 0;a&g.HasChangedDate&&(u=e.Reader.readTimestamp(),i=i&&!e.Reader.Error),i=(h=a&g.ItemIndex16Bit?e.Reader.readUInt16():e.Reader.readUInt32(),i&&!e.Reader.Error),a&g.HasNewValue&&(l=this.cluster.readValue(t,e),i=i&&!e.Reader.Error),a&g.HasPreviousValue&&(p=this.cluster.readValue(t,e),i=i&&!e.Reader.Error),this.operations.push(new this.appStateCollectionOperationType(u,c,h,l,p,!1))}}}return i},e.prototype.serializeDelta=function(r,n){var i=this;r.Writer.writeString(n),r.Writer.writeTimestamp(this.changedAt),r.Writer.writeInt32(this.operations.length),this.operations.forEach(function(e){var t=(e.ItemIndex<65536?g.ItemIndex16Bit:g.None)|(e.IsNewValueDefined?g.HasNewValue:g.None)|(e.IsPreviousValueDefined&&i.serializePreviousValues?g.HasPreviousValue:g.None)|(i.serializeOperationChangedAt?g.HasChangedDate:g.None);r.Writer.writeByte(e.Operation|t),t&g.HasChangedDate&&r.Writer.writeTimestamp(e.ChangedAt),t&g.ItemIndex16Bit?r.Writer.writeUInt16(e.ItemIndex):r.Writer.writeInt32(e.ItemIndex),t&g.HasNewValue&&i.cluster.writeValue(n,r,e.NewValue),t&g.HasPreviousValue&&i.cluster.writeValue(n,r,e.PreviousValue)})},e.prototype.reconcile=function(){var t=this;this.operations.forEach(function(e){if(!e.IsLocal)switch(e.Operation){case d.Clear:t.container.length=0,e.ReconciledItemIndex=-1;break;case d.Append:e.IsNewValueDefined?(t.container.push(e.NewValue),e.ReconciledItemIndex=t.container.length-1):console.error("Expected new value during AppStateCollection.Append reconciliation");break;case d.Insert:e.IsNewValueDefined?e.ItemIndex<t.container.length?(t.container.splice(e.ItemIndex,0,e.NewValue),e.ReconciledItemIndex=e.ItemIndex):(t.container.push(e.NewValue),e.ReconciledItemIndex=t.container.length-1):console.error("Expected new value during AppStateCollection.Insert reconciliation");break;case d.Remove:e.IsPreviousValueDefined?e.ItemIndex<t.container.length?(t.container.splice(e.ItemIndex,1),e.ReconciledItemIndex=e.ItemIndex):e.ReconciledItemIndex=-1:console.error("Expected previous value during AppStateCollection.Remove reconciliation");break;case d.Replace:e.IsNewValueDefined?e.ItemIndex<t.container.length?(t.container[e.ItemIndex]=e.NewValue,e.ReconciledItemIndex=e.ItemIndex):e.ReconciledItemIndex=-1:console.error("Expected new value during AppStateCollection.Replace reconciliation")}})},e.prototype.beginTransaction=function(){i.prototype.beginTransaction.call(this),this.operations.length=0},e}(c);e.AppStateCollection=w;var S=function(){function e(){this.allInstances=[]}return e.prototype.addInstance=function(e){e.registerEntries(),this.allInstances.push(e)},e.prototype.beginTransaction=function(){for(var e in this.allInstances)this.allInstances[e].beginTransaction()},e.prototype.endTransaction=function(){for(var e in this.allInstances)this.allInstances[e].endTransaction()},e.prototype.applyChanges=function(e){for(var t in this.allInstances){var r=this.allInstances[t];r.isDirty()&&(r.applyChanges(e,r.PeerID,r.InstanceID),e.setDirty())}},e.prototype.serializeClusterInstanceData=function(e,t,r){},e.prototype.serializeTransaction=function(t,e,r){var n=this,i=[];for(var o in this.allInstances){var s=this.allInstances[o];s.isDirty()&&i.push(s)}0<i.length&&(t.Writer.writeString(e),t.Writer.writeUInt16(i.length),i.forEach(function(e){n.serializeClusterInstanceData(e,t,r),e.serializeTransaction(t,r)}))},e.prototype.deserializeTransaction=function(e,t,r){return!1},e}(),I=function(n){function e(e,t){var r=n.call(this)||this;return r.clusterType=t,r.onlyInstance=new t,i.GetInstance().addCluster(e,r),r.addInstance(r.onlyInstance),r}return ie(e,n),e.prototype.getGlobalCluster=function(){return this.onlyInstance},e.prototype.serializeClusterInstanceData=function(e,t,r){},e.prototype.deserializeTransaction=function(e,t,r){var n=!1,i=e.Reader.readUInt16();if(!e.Reader.Error)for(var o=0;o<i;++o){n=this.getGlobalCluster().deserializeTransaction(e,t,r)}return n},e}(e.AppStateClusterManagerBase=S);e.GlobalAppStateClusterManager=I;var A=function(n){function e(e,t){var r=n.call(this)||this;return r.clusterType=t,r.peerClusters={},r.peerClusters[""]=new t,i.GetInstance().addCluster(e,r),r.addInstance(r.peerClusters[""]),r}return ie(e,n),e.prototype.getLocalCluster=function(){return this.allInstances[""]},e.prototype.getCluster=function(e){var t=null;return this.containsCluster(e)?t=this.peerClusters[e]:(t=new this.clusterType,(this.peerClusters[e]=t).PeerID=e,this.addInstance(t)),t},e.prototype.containsCluster=function(e){return null!=this.peerClusters[e]},e.prototype.serializeClusterInstanceData=function(e,t,r){var n=e.PeerID;t.Writer.writeString(0==n.length?r.LocalPeerID:n)},e.prototype.deserializeTransaction=function(e,t,r){var n=!1,i=e.Reader.readUInt16();if(!e.Reader.Error)for(var o=0;o<i;++o){var s=e.Reader.readString();if(!e.Reader.Error)s==t.LocalPeerID&&(s=""),n=this.getCluster(s).deserializeTransaction(e,t,r)}return n},e}(S);e.LocalAppStateClusterManager=A;var M=function(){function e(e,t,r){this.entries={},this.dirty=!1,this.lockCount=0,this.peerID=e||"",this.instanceID=t||"",this.appState=r||i.GetInstance()}return Object.defineProperty(e.prototype,"PeerID",{get:function(){return this.peerID},set:function(e){this.peerID=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"InstanceID",{get:function(){return this.instanceID},enumerable:!0,configurable:!0}),e.prototype.beginTransaction=function(){for(var e in this.dirty=!1,this.entries)this.entries[e].beginTransaction()},e.prototype.endTransaction=function(){for(var e in this.entries)this.entries[e].endTransaction()},e.prototype.reconcile=function(e){for(var t in this.entries)this.entries[t].reconcile()},e.prototype.setDirty=function(){this.dirty=!0},e.prototype.isDirty=function(){return this.dirty},e.prototype.registerEntry=function(e,t){(this.entries[e]=t).register(e,this)},e.prototype.applyChanges=function(e,t,r){},e.prototype.serializeTransaction=function(t,e){var r=[];for(var n in this.entries)this.entries[n].isDirty()&&r.push({key:n,entry:this.entries[n]});t.Writer.writeUInt16(r.length),r.forEach(function(e){e.entry.serializeDelta(t,e.key)})},e.prototype.deserializeTransaction=function(e,t,r){var n=!0,i=e.Reader.readUInt16();if(e.Reader.Error)n=!1;else for(var o=0;o<i&&n;++o){var s=e.Reader.readString();if(e.Reader.Error)n=!1;else{var a=this.entries[s];n=!!a&&a.deserializeDelta(e,s)}}return n&&this.reconcile(r),n},e.prototype.lock=function(){++this.lockCount},e.prototype.unlock=function(){--this.lockCount},Object.defineProperty(e.prototype,"IsLocked",{get:function(){return 0<this.lockCount},enumerable:!0,configurable:!0}),e.prototype.readValue=function(e,t){console.error("readValue not implemented for "+e)},e.prototype.writeValue=function(e,t,r){console.error("writeValue not implemented for "+e)},e}();e.AppStateCluster=M;var T=function(){function e(e){this.pendingUpdates=[],this.pendingMessages=[],this.appState=e}return Object.defineProperty(e.prototype,"Scene",{set:function(e){this.scene=e},enumerable:!0,configurable:!0}),e.prototype.beginFrame=function(){this.appState.beginTransaction()},e.prototype.commit=function(){this.acquirePendingUpdates().forEach(function(e){e()}),this.appState.endTransaction()},e.prototype.submitLocalUpdates=function(e){var t=new s(new o);t.Writer.writeInt32(1),t.Writer.writeInt32(256),this.appState.serializeTransaction(t);var r=t.Writer.flush(),n=te.modelstageweb.NetworkChannelMessage.FromBuffer(r);n.HasPayload&&e.IsConnected&&e.send(n.Content)},e.prototype.applyRemoteUpdates=function(){var t=this;this.acquirePendingMessages().forEach(function(e){t.appState.deserializeTransaction(new n(new r(e.Content)),t.scene)})},e.prototype.acquirePendingUpdates=function(){var e=this.pendingUpdates;return this.pendingUpdates=[],e},e.prototype.acquirePendingMessages=function(){var e=this.pendingMessages;return this.pendingMessages=[],e},e.prototype.endFrame=function(){this.appState.applyChanges(this.scene)},e.prototype.receivedMessage=function(e){this.pendingMessages.push(e)},e.prototype.synchronizeStateUpdate=function(e){this.pendingUpdates.push(e)},e}();e.Director=T;var P=function(n){function e(e,t){var r=n.call(this)||this;return r.director=e,r.connection=t,r}return ie(e,n),e.prototype.beginFrame=function(){this.director.beginFrame()},e.prototype.update=function(){this.director.commit(),this.connection&&this.connection.IsConnected&&(this.director.submitLocalUpdates(this.connection),this.director.applyRemoteUpdates())},e.prototype.endFrame=function(){this.director.endFrame()},e.prototype.receivedMessage=function(e){e.MessageType!=te.modelstageweb.CommonMessageTypes.AppStateDelta&&e.MessageType!=te.modelstageweb.CommonMessageTypes.AppStateInitialization||this.director.receivedMessage(e)},e.prototype.synchronizeStateUpdate=function(e){this.director.synchronizeStateUpdate(e)},e}(te.modelstageweb.SceneWebGL);e.DirectedSceneWebGL=P}(te.modelstageappstate||(te.modelstageappstate={})),function(e){var r=function(){function e(){}return e.prototype.animationFrame=function(e){return window.requestAnimationFrame(e)},e}(),o=function(){function e(e,t,r){this.scene=e,this.stage=t,this.actor=r,this.vertices=[],this.floorLevel=0}return Object.defineProperty(e.prototype,"FloorLevel",{get:function(){return this.floorLevel},set:function(e){this.floorLevel=e},enumerable:!0,configurable:!0}),e.prototype.initializeSquareRoom=function(e,t){t.addQuad(-5,0,-5,0,0,5,0,-5,1,0,5,0,5,1,1,-5,0,5,0,1,.3,.3,.3,!0),e.addQuad(-5,0,-5,5,0,-5,5,2.6,-5,-5,2.6,-5,.1,.1,.1,.4,!0),e.addQuad(-5,0,5,-5,2.6,5,5,2.6,5,5,0,5,.1,.1,.1,.4,!0),e.addQuad(-5,0,-5,-5,2.6,-5,-5,2.6,5,-5,0,5,.15,.15,.15,.4,!0),e.addQuad(5,0,-5,5,0,5,5,2.6,5,5,2.6,-5,.15,.15,.15,.4,!0)},e.prototype.initializeArbitraryRoom=function(e,t){for(var r=!1,n=new te.psgeometry.Polygon2D,i=0;i<this.vertices.length;i++)n.addVector(this.vertices[i]);var o=new te.psgeometry.AABB2D;n.addToAABB(o);var s=o.extents();this.stage.updateShadowArea(o),n=n.triangulate();for(i=0;i<n.Vertices.length;i+=3)t.addTri(n.Vertices[i].x,0,n.Vertices[i].y,(n.Vertices[i].x-o.minX)/s.x,(n.Vertices[i].y-o.minY)/s.y,n.Vertices[i+1].x,0,n.Vertices[i+1].y,(n.Vertices[i+1].x-o.minX)/s.x,(n.Vertices[i+1].y-o.minY)/s.y,n.Vertices[i+2].x,0,n.Vertices[i+2].y,(n.Vertices[i+2].x-o.minX)/s.x,(n.Vertices[i+2].y-o.minY)/s.y,.2,.2,.2,!0);for(i=0;i<this.vertices.length;i++){var a=this.vertices[i],c=this.vertices[(i+1)%this.vertices.length];e.addQuad(a.x,0,a.y,c.x,0,c.y,c.x,2.6,c.y,a.x,2.6,a.y,r?.1:.15,r?.1:.15,r?.1:.15,.4,!0),r=!r}},e.prototype.updateSpace=function(){var e=new te.modelstageweb.BufferAssetWebGL(undefined,"space_indices",!0),t=new te.modelstageweb.BufferAssetWebGL(undefined,"space_vertices",!1),r=new te.modelstageweb.TransparentMeshBuilder(t,e),n=new te.modelstageweb.BufferAssetWebGL(undefined,"floor_indices",!0),i=new te.modelstageweb.BufferAssetWebGL(undefined,"floor_vertices",!1),o=new te.modelstageweb.TexturedMeshBuilder(i,n);this.vertices.length<3?this.initializeSquareRoom(r,o):this.initializeArbitraryRoom(r,o);var s=new te.modelstageweb.FigureWebGL("Space");o.initialize(this.stage),this.stage.AssetStore.addBufferAsset("floor_indices",n),this.stage.AssetStore.addBufferAsset("floor_vertices",i);var a=new te.modelstageweb.MeshShaderInstance("TexturedMeshShader");a.addReference("IndexBuffer","floor_indices"),a.addReference("VertexBuffer","floor_vertices"),a.addReference("TextureBuffer","Shadow"),s.addShaderInstance(a),r.initialize(this.stage),this.stage.AssetStore.addBufferAsset("space_indices",e),this.stage.AssetStore.addBufferAsset("space_vertices",t);var c=new te.modelstageweb.MeshShaderInstance("TransparentMeshShader");c.addReference("IndexBuffer","space_indices"),c.addReference("VertexBuffer","space_vertices"),s.addShaderInstance(c),this.actor.Figures[0]=s,this.actor.Filter=new te.modelstageweb.GenericSceneItemFilterWebGL,this.actor.Scene.setDirty()},e.prototype.clearVertices=function(){this.vertices.length=0},e.prototype.addVertex=function(e,t){this.vertices.push(new te.psgeometry.Vec2(e,t))},e}();e.SpaceModel=o;var t=function(){function e(e){var t=this;this.stage=new te.modelstageweb.StageWebGL(e),this.stage.initialize(),this.timer=new r,this.timer.animationFrame(function(){t.processFrame()}),document.addEventListener("visibilitychange",function(){t.onVisibilityChange()},!1),this.initialize()}return Object.defineProperty(e.prototype,"Stage",{get:function(){return this.stage},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Scene",{get:function(){return this.scene},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){},e.prototype.processFrame=function(){var e=this;this.scene&&this.scene.IsInitialized&&(document.hidden||this.render(),this.scene.update(),this.scene.endFrame(),this.scene.beginFrame()),this.timer.animationFrame(function(){e.processFrame()})},e.prototype.render=function(){this.scene.IsInitialized&&this.stage.render(this.scene)},e.prototype.onVisibilityChange=function(){var e=this;document.hidden||this.timer.animationFrame(function(){e.render()})},e}();e.TheaterWebGL=t;var n=function(r){function e(e){var t=r.call(this)||this;return t.connection=e,t}return ie(e,r),e.prototype.getSceneObj=function(e){for(var t=0,r=null;t<d.GlobalInstance.SceneObjects.Count&&!r;)d.GlobalInstance.SceneObjects.GetItemAt(t).SceneObjectID==e?r=d.GlobalInstance.SceneObjects.GetItemAt(t):++t;return[r,t]},e.prototype.updateModelTransform=function(e){var t=e.Data.translate||te.psgeometry.Vec4.Zero,r=e.Data.rotate||te.psgeometry.Vec4.Zero;this.connection.send("Scene|Transform|"+e.SceneItemID+"|"+t.x+","+t.y+","+t.z+"|"+r.y+","+r.x+","+r.z);var n=te.psgeometry.Matrix4.FromTranslation(t.x,t.y,t.z),i=te.psgeometry.Matrix4.FromRotationY(r.y);e.State.set("ModelTransform",i.multiply(n)),e.Scene.setDirty()},e.prototype.updateActorTranslation=function(e,t,r,n){e.Data.translate=new te.psgeometry.Vec4(t,r,n),this.updateModelTransform(e)},e.prototype.updateActorRotation=function(e,t,r,n){e.Data.rotate=new te.psgeometry.Vec4(t,r,n),this.updateModelTransform(e)},e}(te.modelstageweb.Tool),i=function(i){function w(e,t,r){var n=i.call(this,r)||this;return n.scene=e,n.stage=t,n}return ie(w,i),w.prototype.enter=function(e){i.prototype.enter.call(this,e),this.updateSelectionMarker()},w.prototype.leave=function(){this.removeSelectionMarker()},w.prototype.handleKeyUp=function(e){if(46==e.keyCode&&this.selectedActor){var t=S(this.getSceneObj(this.selectedActor.Data.SceneObjID),2),r=t[0],n=t[1];if(r)return d.GlobalInstance.SceneObjects.remove(n),this.removeSelectionMarker(),!(this.selectedActor=null)}return!1},w.prototype.removeSelectionMarker=function(){this.scene.removeSceneItem(w.SelectionObjectID)},w.prototype.updateSelectionMarker=function(){var e;if(this.scene.removeSceneItem(w.SelectionObjectID),this.selectedActor){var t=new te.psgeometry.AABB3D;this.selectedActor.Figures.forEach(function(e){t.addAABB(e.getBoundingBox())});var r=new te.psgeometry.Vec3(t.center().x,t.minY,t.center().z),n=new te.modelstageweb.ActorWebGL(this.scene,w.SelectionObjectID),i=S([.16,.34,.6],3),o=i[0],s=i[1],a=i[2],c=new te.modelstageweb.OpaqueMeshBuilder;c.addStroke(t.minX,t.maxY,t.minZ,t.maxX,t.maxY,t.minZ,o,s,a),c.addStroke(t.maxX,t.maxY,t.minZ,t.maxX,t.maxY,t.maxZ,o,s,a),c.addStroke(t.maxX,t.maxY,t.maxZ,t.minX,t.maxY,t.maxZ,o,s,a),c.addStroke(t.minX,t.maxY,t.maxZ,t.minX,t.maxY,t.minZ,o,s,a),c.addStroke(t.minX,t.minY,t.minZ,t.maxX,t.minY,t.minZ,o,s,a),c.addStroke(t.maxX,t.minY,t.minZ,t.maxX,t.minY,t.maxZ,o,s,a),c.addStroke(t.maxX,t.minY,t.maxZ,t.minX,t.minY,t.maxZ,o,s,a),c.addStroke(t.minX,t.minY,t.maxZ,t.minX,t.minY,t.minZ,o,s,a),c.addStroke(t.minX,t.minY,t.minZ,t.minX,t.maxY,t.minZ,o,s,a),c.addStroke(t.minX,t.minY,t.maxZ,t.minX,t.maxY,t.maxZ,o,s,a),c.addStroke(t.maxX,t.minY,t.minZ,t.maxX,t.maxY,t.minZ,o,s,a),c.addStroke(t.maxX,t.minY,t.maxZ,t.maxX,t.maxY,t.maxZ,o,s,a),n.addFigure(c.createFigure(this.stage,"SEL_MARKER"));var u=new te.psgeometry.AABB3D;o=(e=S([.6,.1,.1],3))[0],s=e[1],a=e[2];for(var h=new te.modelstageweb.OpaqueMeshBuilder,l=0;l<24;++l){var p=2*Math.PI/24*l,f=2*Math.PI/24*(l+1),d=new te.psgeometry.Vec3(1*Math.sin(p),0,1*Math.cos(p)).add(r),y=new te.psgeometry.Vec3(1*Math.sin(f),0,1*Math.cos(f)).add(r),g=new te.psgeometry.Vec3(1.1*Math.sin(p),0,1.1*Math.cos(p)).add(r),m=new te.psgeometry.Vec3(1.1*Math.sin(f),0,1.1*Math.cos(f)).add(r);h.addQuad(g.x,g.y+.02,g.z,m.x,m.y+.02,m.z,y.x,y.y+.02,y.z,d.x,d.y+.02,d.z,o,s,a),h.addQuad(g.x,m.y-.02,g.z,m.x,m.y-.02,m.z,m.x,m.y+.02,m.z,g.x,g.y+.02,g.z,o,s,a),h.addQuad(d.x,d.y-.02,d.z,y.x,y.y-.02,y.z,m.x,m.y-.02,m.z,g.x,g.y-.02,g.z,o,s,a),u.addVector(g)}var b=h.createFigure(this.stage,"ROT_MARKER");b.setIntersector(new te.modelstageweb.BoundingBoxIntersector(u)),n.addFigure(b);var v=this.scene.State.get("SceneObjectPos"+this.selectedActor.Data.SceneObjID,te.psgeometry.Vec4.Zero),x=this.scene.State.get("SceneObjectRot"+this.selectedActor.Data.SceneObjID,te.psgeometry.Vec4.Zero);n.State.set("ModelTransform",te.psgeometry.Matrix4.FromRotation(x.x,x.y,x.z).multiply(te.psgeometry.Matrix4.FromTranslation(v.x,v.y,v.z))),n.Filter=new te.modelstageweb.GenericSceneItemFilterWebGL,this.scene.addSceneItem(n,!0)}},w.prototype.handleMouseDown=function(e){var t=this.stage.Camera.getViewRay(e.clientX,e.clientY),r=[];this.scene.getIntersectionCandidates(t,r);for(var n=!1,i=0;!n&&i<r.length;){if(r[i].sceneItem instanceof te.modelstageweb.ActorWebGL){var o=r[i].sceneItem;n=(o.SceneItemID!=w.SelectionObjectID?o==this.selectedActor?this.interfaceController.pushTool(new u(o,this.stage.Camera,this.connection)):(this.selectedActor=o,this.updateSelectionMarker()):this.interfaceController.pushTool(new h(this.selectedActor,this.stage.Camera,this.connection)),!0)}i++}n||(this.scene.removeSceneItem(w.SelectionObjectID),this.selectedActor=null)},w.prototype.handleMouseMove=function(e,t,r){},w.prototype.handleMouseUp=function(e){},w.SelectionObjectID="SEL_MARKER",w}(e.ActorManipulationTool=n);e.SelectionTool=i;var s=function(i){function e(e,t,r){var n=i.call(this,r)||this;return n.camera=t,n.sceneObj=new f,n.sceneObj.AssetID=e,n.sceneObj.SceneObjectID=te.modelstageweb.uuidv4(),n.sceneObj.Location=new te.psgeometry.Vec4,n.sceneObj.Rotation=new te.psgeometry.Vec4,n.sceneObj.Scale=new te.psgeometry.Vec4(1,1,1,1),d.GlobalInstance.SceneObjects.append(n.sceneObj),n.sceneObjIdx=d.GlobalInstance.SceneObjects.Count-1,n}return ie(e,i),e.prototype.handleMouseMove=function(e,t,r){var n=this.camera.getViewRay(t,r).intersectRayWithPlane(new te.psgeometry.Vec3,new te.psgeometry.Vec3(0,1,0));n&&(this.sceneObj=x({},this.sceneObj),this.sceneObj.Location=new te.psgeometry.Vec4(n.x,0,n.z),d.GlobalInstance.SceneObjects.replace(this.sceneObj,this.sceneObjIdx))},e.prototype.handleMouseUp=function(e){this.interfaceController.popTool()},e}(n);e.PlaceActorTool=s;var c={Administrator:"Administrator",Arne:"Arne Thurm",Ulrich:"Ulrich Bönkemeyer",Tom:"Tom Jachmann",Zacharias:"Zacharias Reinhardt"},a=[[.31,.02,.06,1],[.02,.17,.31,1],[.02,.31,.06,1],[.69,.34,0,1],[.33,0,.53,1]],u=function(i){function e(e,t,r){var n=i.call(this,r)||this;return n.actor=e,n.camera=t,n.isInitialized=!1,n}return ie(e,i),e.prototype.handleMouseMove=function(e,t,r){var n=this.camera.getViewRay(t,r).intersectRayWithPlane(new te.psgeometry.Vec3,new te.psgeometry.Vec3(0,1,0));if(n){if(this.isInitialized){var i=S(this.getSceneObj(this.actor.Data.SceneObjID),2),o=i[0],s=i[1];if(o){var a=x({},o);a.Location;a.Location=a.Location.add(new te.psgeometry.Vec4(n.x-this.lastX,0,n.z-this.lastZ)),d.GlobalInstance.SceneObjects.replace(a,s)}}this.lastX=n.x,this.lastZ=n.z,this.isInitialized=!0}},e.prototype.handleMouseUp=function(e){this.interfaceController.popTool()},e}(n);e.MoveActorTool=u;var h=function(i){function e(e,t,r){var n=i.call(this,r)||this;return n.actor=e,n.camera=t,n}return ie(e,i),e.prototype.handleDrag=function(e,t,r,n,i){var o=1;300<Math.abs(e.clientY-r)?o=6:200<Math.abs(e.clientY-r)?o=3:100<Math.abs(e.clientY-r)&&(o=2);var s=S(this.getSceneObj(this.actor.Data.SceneObjID),2),a=s[0],c=s[1];if(a){var u=x({},a);u.Rotation;u.Rotation=u.Rotation.add(new te.psgeometry.Vec4(n/(100*o)*Math.PI,0,0)),d.GlobalInstance.SceneObjects.replace(u,c)}},e.prototype.handleMouseUp=function(e){this.interfaceController.popTool()},e}(n);e.RotateActorTool=h;var l=function(i){function e(e,t){var r=i.call(this,new te.modelstageappstate.Director(te.modelstageappstate.AppState.GetInstance()),t)||this;r.spaceActor=new te.modelstageweb.ActorWebGL(r,"Space"),(r.director.Scene=r).stage=e,r.spaceModel=new o(r,r.stage,r.spaceActor);var n=new te.modelstageweb.OpaqueMeshShaderProgramWebGL;return n.initialize(e),e.registerShaderProgram("OpaqueMeshShader",n),(n=new te.modelstageweb.TransparentMeshShaderProgramWebGL).initialize(e),e.registerShaderProgram("TransparentMeshShader",n),(n=new te.modelstageweb.TexturedMeshShaderProgramWebGL).initialize(e),e.registerShaderProgram("TexturedMeshShader",n),(n=new te.modelstageweb.MatCapShaderProgramWebGL).initialize(e),e.registerShaderProgram("MatCapMeshShader",n),(n=new te.modelstageweb.ShadowTexturedMeshShaderProgramWebGL).initialize(e),e.registerPhaseSpecificShaderProgram("Shadow","TexturedMeshShader",n),(n=new te.modelstageweb.ShadowTexturedMeshShaderProgramWebGL).initialize(e),e.registerPhaseSpecificShaderProgram("Shadow","MatCapMeshShader",n),r}return ie(e,i),Object.defineProperty(e.prototype,"SpaceModel",{get:function(){return this.spaceModel},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){var e=this;this.addSceneItem(this.spaceActor,!0),this.spaceModel.updateSpace(),ne.when(this.stage.AssetFactory.getFromUrl("/data/hologem.psmesh"),this.stage.AssetFactory.getFromUrl("/data/office_assets_bake.psmesh")).done(function(){e.IsInitialized=!0})},e.prototype.updateSpace=function(){this.spaceModel.clearVertices();for(var e=0;e<p.GlobalInstance.Vertices.Count;++e){var t=p.GlobalInstance.Vertices.GetItemAt(e);this.spaceModel.addVertex(t.x,t.z)}this.spaceModel.updateSpace()},e.prototype.updatePeerInfo=function(e,t,r){if("-1"!=e){var n="peer-info-"+e,i=ne("#"+n);0<i.length?i.find("span").text(r):ne("#participants-view").append('<li id="'+n+'"><img src="images/info/Lens'+t+'.png" /><span>'+r+"</span></li>")}},e.prototype.removePeer=function(e){this.removeSceneItem("Peer"+e);var t=ne("#"+("peer-info-"+e));t.addClass("removing"),setTimeout(function(){t.remove()},2e3)},e.prototype.getColorIndexFromPeerID=function(e){return(parseInt(e)-1)%a.length},e.prototype.createPeer=function(i){var e=new te.modelstageweb.ActorWebGL(this,"Peer"+i);e.addFigure(this.stage.AssetStore.Figures["hololens.hololens.000"]),e.Figures[0].ShaderInstances[0].ShaderKey="MatCapMeshShader";var t=this.getColorIndexFromPeerID(i);return e.State.set("Color",new te.psgeometry.Vec4(a[t][0],a[t][1],a[t][2],a[t][3])),e.State.set("ModelTransform",function(e){var t=e.get("HeadPos"+i,te.psgeometry.Vec4.Zero),r=e.get("CursPos"+i,te.psgeometry.Vec4.Zero).sub(t),n=te.psgeometry.Spherical.FromCartesianVector(r);return te.psgeometry.Matrix4.FromRotationX(-n.azimuth).multiply(te.psgeometry.Matrix4.FromRotationY(-n.polar)).multiply(te.psgeometry.Matrix4.FromTranslation(t.x,t.y,t.z))}),this.addSceneItem(e,!0),e.TestIntersection=!1,e.TestChildrenIntersection=!1,e},e.prototype.createSceneObject=function(e,t){var i=e,r=new te.modelstageweb.ActorWebGL(this,"SceneObject"+i);return r.State.set("ModelTransform",function(e){var t=e.get("SceneObjectPos"+i,te.psgeometry.Vec4.Zero),r=e.get("SceneObjectRot"+i,te.psgeometry.Vec4.Zero),n=e.get("SceneObjectScale"+i,te.psgeometry.Vec4.One);return te.psgeometry.Matrix4.FromRotation(r.x,r.y,r.z).multiply(te.psgeometry.Matrix4.FromScaling(n.x,n.y,n.z).multiply(te.psgeometry.Matrix4.FromTranslation(t.x,t.y,t.z)))}),r.addFigure(this.stage.AssetStore.getFigure(t)),r.Data.SceneObjID=i,r},e}(te.modelstageappstate.DirectedSceneWebGL);e.DemoSceneWebGL=l;var p=function(r){function t(){var e=r.call(this)||this;return e.FloorLevel=new te.modelstageappstate.AppStateFloatValue,e.MasterView=new te.modelstageappstate.AppStateVector4Value,e.Vertices=new te.modelstageappstate.AppStateCollection(te.modelstageappstate.AppStateCollectionOperation),t.GlobalInstance=e}return ie(t,r),t.prototype.registerEntries=function(){this.registerEntry("FloorLevel",this.FloorLevel),this.registerEntry("MasterView",this.MasterView),this.registerEntry("Vertices",this.Vertices)},t.prototype.readValue=function(e,t){return"Vertices"==e?t.Reader.readVec4():r.prototype.readValue.call(this,e,t)},t.prototype.applyChanges=function(e,t,r){this.FloorLevel.isDirty()&&(e.State.set("FloorLevel",this.FloorLevel.get()),e.SpaceModel.FloorLevel=this.FloorLevel.get()),this.MasterView.isDirty()&&e.State.set("MasterViewPos",this.MasterView.get()),this.Vertices.isDirty()&&e.updateSpace()},t.ClusterTypeID="Room",t}(te.modelstageappstate.AppStateCluster);e.RoomAppState=p;var f=function b(){},d=function(n){function t(){var e=n.call(this)||this;return e.SceneObjects=new te.modelstageappstate.AppStateCollection(te.modelstageappstate.AppStateCollectionOperation),t.GlobalInstance=e}return ie(t,n),t.prototype.registerEntries=function(){this.registerEntry("Obj",this.SceneObjects)},t.prototype.readValue=function(e,t){if("Obj"!=e)return n.prototype.readValue.call(this,e,t);var r=new f;return r.SceneObjectID=t.Reader.readCharArray(40),r.AssetID=t.Reader.readCharArray(40),r.Location=t.Reader.readVec4(),r.Rotation=t.Reader.readVec4(),r.Scale=t.Reader.readVec4(),r},t.prototype.writeValue=function(e,t,r){"Obj"==e?(t.Writer.writeCharArray(r.SceneObjectID,40),t.Writer.writeCharArray(r.AssetID,40),t.Writer.writeVec4(r.Location),t.Writer.writeVec4(r.Rotation),t.Writer.writeVec4(te.psgeometry.Vec4.One)):n.prototype.writeValue.call(this,e,t,r)},t.prototype.applyChanges=function(n,e,t){if(this.SceneObjects.isDirty()){var i=n;this.SceneObjects.Operations.forEach(function(e){if(e.Operation==te.modelstageappstate.OperationType.Append){var t=e.NewValue.SceneObjectID,r=e.NewValue.AssetID;i.addSceneItem(i.createSceneObject(t,r),!0),n.State.set("SceneObjectPos"+t,e.NewValue.Location),n.State.set("SceneObjectRot"+t,e.NewValue.Rotation),n.State.set("SceneObjectScale"+t,e.NewValue.Scale)}else if(e.Operation==te.modelstageappstate.OperationType.Replace){t=e.NewValue.SceneObjectID;n.State.set("SceneObjectPos"+t,e.NewValue.Location),n.State.set("SceneObjectRot"+t,e.NewValue.Rotation),n.State.set("SceneObjectScale"+t,e.NewValue.Scale)}else if(e.Operation==te.modelstageappstate.OperationType.Remove){t=e.PreviousValue.SceneObjectID;n.removeSceneItem("SceneObject"+t)}})}},t.ClusterTypeID="Obj",t}(te.modelstageappstate.AppStateCluster);e.SceneAppState=d;var y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.headPos=new te.modelstageappstate.AppStateVector4Value,e.cursorPos=new te.modelstageappstate.AppStateVector4Value,e.userID=new te.modelstageappstate.AppStateStringValue,e.active=new te.modelstageappstate.AppStateBoolValue,e}return ie(e,t),e.prototype.providesInitializationData=function(){return!0},e.prototype.registerEntries=function(){this.registerEntry("Head",this.headPos),this.registerEntry("Curs",this.cursorPos),this.registerEntry("User",this.userID),this.registerEntry("Active",this.active)},e.prototype.applyChanges=function(e,t,r){var n=e;if(0<t.length&&(this.headPos.isDirty()||this.cursorPos.isDirty())){n.getSceneItem("Peer"+t)||n.createPeer(t);var i=new te.psgeometry.Vec4(0,-n.SpaceModel.FloorLevel,0,0),o=this.headPos.get(),s=this.cursorPos.get();o&&s&&(e.State.set("HeadPos"+t,o.add(i)),e.State.set("CursPos"+t,s.add(i)))}if(this.userID.isDirty()){var a=c[this.userID.get()]||"";n.updatePeerInfo(t,n.getColorIndexFromPeerID(t),a)}this.active.isDirty()&&(this.active.get()||n.removePeer(t))},e.ClusterTypeID="Peer",e}(te.modelstageappstate.AppStateCluster);e.PeerAppState=y;var g=function v(){},m=function(n){function t(){var e=n.call(this)||this;return e.Notes=new te.modelstageappstate.AppStateCollection(te.modelstageappstate.AppStateCollectionOperation),t.GlobalInstance=e}return ie(t,n),t.prototype.registerEntries=function(){this.registerEntry("Notes",this.Notes)},t.prototype.readValue=function(e,t){if("Notes"!=e)return n.prototype.readValue.call(this,e,t);var r=new g;return r.NoteID=t.Reader.readCharArray(20),r.NoteType=t.Reader.readUInt32(),r.OwnerID=t.Reader.readCharArray(10),r.Location=t.Reader.readVec4(),r.AzimuthalRotation=t.Reader.readFloat32(),r},t.prototype.writeValue=function(e,t,r){"Notes"==e?(t.Writer.writeCharArray(r.NoteID,20),t.Writer.writeInt32(r.NoteType),t.Writer.writeCharArray(r.OwnerID,10),t.Writer.writeVec4(r.Location),t.Writer.writeFloat32(r.AzimuthalRotation)):n.prototype.writeValue.call(this,e,t,r)},t.ClusterTypeID="Notes",t}(te.modelstageappstate.AppStateCluster);e.NotesAppState=m}(te.ɵa||(te.ɵa={}));var e=function(){function e(){}return e.prototype.extractPart=function(e){var t=e.indexOf("|");return 0<=t?{part:e.substring(0,t),remainder:e.substring(t+1)}:{remainder:"",part:e}},e.prototype.processMessage=function(e){},e}(),t=function(t){function e(e){var c=t.call(this,e)||this;return c.peerAppState=new te.modelstageappstate.LocalAppStateClusterManager(te.ɵa.PeerAppState.ClusterTypeID,te.ɵa.PeerAppState),c.sceneAppState=new te.modelstageappstate.GlobalAppStateClusterManager(te.ɵa.SceneAppState.ClusterTypeID,te.ɵa.SceneAppState),c.roomAppState=new te.modelstageappstate.GlobalAppStateClusterManager(te.ɵa.RoomAppState.ClusterTypeID,te.ɵa.RoomAppState),c.notesAppState=new te.modelstageappstate.GlobalAppStateClusterManager(te.ɵa.NotesAppState.ClusterTypeID,te.ɵa.NotesAppState),c.actorIndex=1,c.channels={},c.connection=new te.modelstageweb.SignalRServerConnection,c.scene=new te.ɵa.DemoSceneWebGL(c.stage,c.connection),c.scene.initialize(),c.connection.onConnected(function(){}),c.connection.onMessage(function(e){if(e.data instanceof ArrayBuffer||e.data instanceof Uint8Array){var t=e.data instanceof Uint8Array?e.data:new Uint8Array(e.data),r=te.modelstageweb.NetworkChannelMessage.FromBuffer(t);c.scene.receivedMessage(r)}else if("string"==typeof e.data){var n=e.data,i=n.indexOf("|");if(0<=i){var o=n.substring(0,i),s=n.substr(i+1),a=c.channels[o];a&&a.processMessage(s)}}else console.warn("Received invalid message type: "+typeof e.data)}),c.interfaceController=new te.modelstageweb.InterfaceController,c.cameraController=new te.modelstageweb.CameraController(c.Stage,c.Stage.Camera,c.interfaceController,c.connection),c.cameraController.construct(12,-.45,0),c.interfaceController.pushTool(new te.ɵa.SelectionTool(c.scene,c.stage,c.connection)),r.$(function(){c.connection.connect(),r.$(".area-right-sidebar ul li").draggable({containment:"document",cursor:"crosshair",helper:"clone",opacity:.5,scroll:!1}),r.$("#viewCanvas").droppable({})}),c}return ie(e,t),e.prototype.initialize=function(){},e}(te.ɵa.TheaterWebGL);te.modelstage=te.ɵa,te.MessageChannel=e,te.SampleTheaterWebGL=t,Object.defineProperty(te,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-modelstage.umd.min.js.map